<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Trainer Minimal</title>
<style>
  :root{
    --bg:#0c1220; --card:#121a2b; --chip:#0e1526;
    --text:#e9eef6; --muted:#9fb0c6;
    --ok:#39d98a; --ng:#ff6b6b; --btn:#1d2a44; --btnActive:#2a3b62;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.55 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue","Hiragino Sans","Noto Sans JP","Yu Gothic UI","YuGothic","Meiryo",sans-serif;}
  .wrap{max-width:820px;margin:24px auto;padding:0 16px}
  .panel{background:var(--card);border-radius:20px;padding:22px 20px;box-shadow:0 0 0 1px rgba(255,255,255,.04) inset}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .chip{background:var(--chip);border-radius:14px;padding:8px 12px;font-weight:600;letter-spacing:.08em;opacity:.95}
  .title{font-size:clamp(20px,4.5vw,34px);font-weight:800;margin:6px 0 8px}
  .stat{display:flex;gap:18px;align-items:center;color:var(--muted);font-weight:700}
  .stat b{font-weight:800;color:var(--text)}
  .ok{color:var(--ok)} .ng{color:var(--ng)}
  .bar{height:8px;border-radius:99px;background:#0b1222;overflow:hidden}
  .bar>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#2f57ff,#6ee7f9);transition:width .25s}
  .card{background:var(--card);border-radius:18px;padding:18px 16px;margin-top:14px;box-shadow:0 0 0 1px rgba(255,255,255,.04) inset}
  .qtext{white-space:pre-wrap}
  .choicesInText{margin-top:12px;color:#c9d6e6}
  .choicesInText div{margin:8px 0 0}
  .gridBtns{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:16px}
  button.opt{appearance:none;border:0;border-radius:14px;padding:14px 0;background:var(--btn);color:#b8cdf0;font-weight:800;font-size:20px;letter-spacing:.2em;transition:.12s}
  button.opt:active{transform:translateY(1px)}
  button.opt.correct{background:rgba(57,217,138,.14);color:var(--ok);box-shadow:0 0 0 1px rgba(57,217,138,.35) inset}
  button.opt.wrong{background:rgba(255,107,107,.16);color:var(--ng);box-shadow:0 0 0 1px rgba(255,107,107,.35) inset}
  .footer{display:flex;justify-content:center;gap:12px;margin-top:18px}
  .ghost{opacity:.65}
  .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#18233a;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.35);font-size:14px;display:none;z-index:9}
  .timer{margin-left:auto;background:var(--chip);padding:8px 10px;border-radius:12px;font-variant-numeric:tabular-nums}
  @media (hover:hover){
    button.opt:hover{background:var(--btnActive)}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <div class="row">
      <span class="chip">模試</span>
      <div class="title" id="pageTitle">Trainer Minimal</div>
    </div>
    <div class="row stat" style="margin:8px 0 10px">
      <div id="qpos">Q 0 / 0</div>
      <div class="ok">正解 <b id="ok">0</b></div>
      <div class="ng">不正解 <b id="ng">0</b></div>
      <div class="timer" id="timer">120:00</div>
    </div>
    <div class="bar"><i id="prog"></i></div>

    <div class="card">
      <div id="qtext" class="qtext">読み込み中…</div>
      <div id="choicesInText" class="choicesInText" aria-live="polite"></div>
      <div class="gridBtns">
        <button class="opt" data-idx="0">ア</button>
        <button class="opt" data-idx="1">イ</button>
        <button class="opt" data-idx="2">ウ</button>
        <button class="opt" data-idx="3">エ</button>
      </div>
    </div>

    <div class="footer">
      <button id="reload" class="chip">再読込</button>
    </div>
  </div>
</div>
<div id="toast" class="toast"></div>

<script>
(function(){
  const JSON_PATH = "data/itpassport_2025r07.json"; // ここを差し替えれば別ファイルもOK
  const dom = {
    title: document.getElementById('pageTitle'),
    qpos: document.getElementById('qpos'),
    ok: document.getElementById('ok'),
    ng: document.getElementById('ng'),
    prog: document.getElementById('prog'),
    qtext: document.getElementById('qtext'),
    choicesText: document.getElementById('choicesInText'),
    btns: Array.from(document.querySelectorAll('button.opt')),
    timer: document.getElementById('timer'),
    reload: document.getElementById('reload'),
    toast: document.getElementById('toast'),
  };

  let data = null;
  let idx = 0;
  let ok = 0, ng = 0;
  let locked = false;
  let timerSec = 120*60;
  let tickId = null;

  function toast(msg, ms=2600){
    dom.toast.textContent = msg;
    dom.toast.style.display = 'block';
    clearTimeout(dom.toast._t);
    dom.toast._t = setTimeout(()=>dom.toast.style.display='none', ms);
  }

  async function load(){
    try{
      const url = JSON_PATH + "?t=" + Date.now(); // キャッシュ回避
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok){
        throw new Error(`HTTP ${res.status}：JSON を取得できません（パス/公開設定を確認）`);
      }
      const txt = await res.text();

      // JSON バリデーション（よくある「先頭にゴミ」が混ざったケースにも対処）
      let clean = txt.trim();
      // 先頭が { 以外なら余分な行を削る（例：「title": "...", のようなゴミが先頭にある）
      const firstBrace = clean.indexOf('{');
      if(firstBrace>0){ clean = clean.slice(firstBrace); }
      const lastBrace = clean.lastIndexOf('}');
      if(lastBrace !== clean.length-1 && lastBrace>0){ clean = clean.slice(0,lastBrace+1); }

      const json = JSON.parse(clean);

      // 期待構造の柔軟対応：トップ直下に questions があればそれを使う
      if(json && Array.isArray(json.questions)){
        data = json;
      }else{
        throw new Error("JSON の形式エラー：top-level に questions 配列が見つかりません。");
      }

      // タイトル
      if(typeof data.title === 'string' && data.title.trim()){
        dom.title.textContent = data.title.trim();
        document.title = data.title.trim() + " | Trainer Minimal";
      }else{
        // title が無ければ据え置き
      }

      // 先頭整形
      idx = 0; ok=0; ng=0; locked=false;
      dom.ok.textContent = ok; dom.ng.textContent = ng;
      setProg();
      render();

      // タイマー開始（初回のみ）
      if(!tickId){
        tickId = setInterval(()=>{
          timerSec--;
          if(timerSec<0){ timerSec=0; clearInterval(tickId); }
          const m = Math.floor(timerSec/60).toString().padStart(2,'0');
          const s = (timerSec%60).toString().padStart(2,'0');
          dom.timer.textContent = `${m}:${s}`;
        },1000);
      }

    }catch(err){
      console.error(err);
      toast("読み込み失敗：" + err.message);
      dom.qtext.textContent = "読み込みに失敗しました。JSON の置き場所 / フォーマットをご確認ください。";
      dom.choicesText.innerHTML = "";
    }
  }

  function setProg(){
    const total = data?.questions?.length ?? 0;
    dom.qpos.textContent = `Q ${Math.min(idx+1,total)} / ${total}`;
    const w = total ? ((idx)/total*100) : 0;
    dom.prog.style.width = w + "%";
  }

  function render(){
    const qs = data.questions;
    if(!qs || !qs.length){
      dom.qtext.textContent = "出題できる問題がありません。";
      dom.choicesText.innerHTML = "";
      return;
    }
    if(idx>=qs.length){
      // 終了
      dom.qtext.innerHTML = `おつかれさま！<br>正解：<b class="ok">${ok}</b>　不正解：<b class="ng">${ng}</b> / 全${qs.length}問`;
      dom.choicesText.innerHTML = "";
      dom.btns.forEach(b=>{ b.disabled=true; b.classList.remove('correct','wrong'); });
      dom.prog.style.width = "100%";
      return;
    }

    const q = qs[idx];

    // 本文
    dom.qtext.textContent = (q.question || "").trim();

    // 選択文は本文下へ追記（「ア …」形式）。choices が無ければ何も出さない
    dom.choicesText.innerHTML = "";
    if(Array.isArray(q.choices) && q.choices.length){
      const kana = ["ア","イ","ウ","エ","オ","カ","キ","ク"];
      q.choices.slice(0,4).forEach((t,i)=>{
        const line = document.createElement('div');
        // 既に【ア】などが含まれていても二重にならないよう整形
        const txt = String(t).replace(/^【?[ア-ン]】?/,'').trim();
        line.textContent = `${kana[i]}　${txt}`;
        dom.choicesText.appendChild(line);
      });
    }

    // ボタン状態リセット
    locked = false;
    dom.btns.forEach(b=>{ b.disabled=false; b.classList.remove('correct','wrong'); });

    setProg();
  }

  function judge(chosenIdx){
    if(locked) return;
    const q = data.questions[idx];
    const ans = Number(q.answer_index ?? -1);
    locked = true;

    // 配色
    dom.btns.forEach((b,i)=>{
      if(i===ans) b.classList.add('correct');
    });
    if(chosenIdx===ans){
      ok++; dom.ok.textContent=ok;
    }else{
      ng++; dom.ng.textContent=ng;
      dom.btns[chosenIdx]?.classList.add('wrong');
    }

    // 次へ（0.6秒後）
    setTimeout(()=>{
      idx++;
      render();
    }, 600);
  }

  // クリック
  dom.btns.forEach(b=>{
    b.addEventListener('click', ()=>judge(Number(b.dataset.idx)));
  });

  // 再読込
  dom.reload.addEventListener('click', ()=>{ load(); });

  // 初回
  load();

  // ダブルタップ拡大を抑止（iOS）
  let lastTouch=0;
  document.addEventListener('touchend', (e)=>{
    const now = Date.now();
    if(now-lastTouch<350){ e.preventDefault(); }
    lastTouch = now;
  }, {passive:false});

})();
</script>
</body>
</html>