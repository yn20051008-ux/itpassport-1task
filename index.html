<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Trainer Minimal</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<style>
:root{ --bg:#0b0d14; --panel:#121623; --accent:#52b2ff; --text:#eef3ff; --muted:#91a0bd; --ok:#4caf50; --ng:#ef5350; --line:#20273a; }
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:linear-gradient(180deg,#0b0d14,#0a1020);
  color:var(--text);font:16px/1.7 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  overscroll-behavior:none; touch-action:manipulation; overflow-x:hidden;
}
.app{max-width:960px;margin:0 auto;padding:18px 18px calc(18px + env(safe-area-inset-bottom));min-height:100svh;display:block;}
.card{background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,.28)}
.pad{padding:16px}
@media(max-width:420px){ .pad{padding:12px} }
h1,h2,p{margin:0}
.muted{color:var(--muted)} .small{font-size:12px} .hide{display:none}

/* HUD */
.top{display:flex;align-items:center;gap:12px;justify-content:space-between}
.top .left{display:flex;align-items:center;gap:10px}
.badge{font-size:12px;padding:2px 8px;border:1px solid var(--line);border-radius:999px;color:#bcd2ff}
.timer{font-variant-numeric:tabular-nums;padding:0;border:0;background:transparent;}
.counters{display:flex;gap:10px}
.counter{font-variant-numeric:tabular-nums}
.counter.ok{color:#b7ffb7}
.counter.ng{color:#ffb4b4}
.bar{height:10px;background:#1a2132;border-radius:999px;overflow:hidden;margin:8px 0 0}
.bar>i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#95d0ff);width:0%}

/* 問題表示（コンパクト） */
.q{font-size:clamp(15px,3.9vw,18px);line-height:1.6;white-space:pre-wrap}
.choice-list{margin-top:10px;display:grid;grid-template-columns:1fr;gap:8px}
.choice-line{display:flex;gap:.6rem;align-items:flex-start}
.choice-line .kana{flex:0 0 2.2ch;text-align:center;color:#b9c6e6}
.choice-line p{margin:0;white-space:pre-wrap}

/* ボタン：1行4列・かなのみ（>4は折返し） */
.answers{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:14px}
.opt{
  display:flex;align-items:center;justify-content:center;min-height:44px;
  padding:10px;border:1px solid #27314a;background:#151c2c;border-radius:12px;
  cursor:pointer;user-select:none;touch-action:manipulation;box-shadow:0 6px 18px rgba(0,0,0,.22);
  font-size:18px;letter-spacing:.1em;
  /* ▼ 修正：ボタン文字色を常に白にする */
  color: var(--text);
}
.opt:hover{border-color:#33415f}
.opt.correct{border-color:var(--ok);background:rgba(76,175,80,.12)}
.opt.wrong{border-color:var(--ng);background:rgba(239,83,80,.12)}
/* ▼ 修正：無効化時も白を維持 */
.opt[disabled]{opacity:.6;cursor:default;color:var(--text)}

/* floating nav */
.fab{position:fixed;right:16px;bottom:calc(16px + env(safe-area-inset-bottom));width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#16213a;border:1px solid #283655;cursor:pointer;box-shadow:0 10px 24px rgba(0,0,0,.35);z-index:50}
.fab span{font-size:20px;line-height:1}

/* overlay nav */
.overlay{position:fixed;inset:0;background:rgba(6,10,20,.65);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;padding:16px;z-index:40}
.ov-card{width:min(860px,92vw);max-height:80vh;overflow:auto;background:#0f1426;border:1px solid #2b3653;border-radius:14px;padding:14px}
.grid{display:grid;grid-template-columns:repeat(10,1fr);gap:6px}
.navbtn{padding:8px;border:1px solid #2a3553;background:#121a33;color:#cdd7f3;border-radius:10px;cursor:pointer}
.navbtn:hover{border-color:#3c4c75}
.navbtn.cur{outline:2px solid var(--accent)}
.navbtn.ok{border-color:#2e7d32;background:rgba(46,125,50,.15)}
.navbtn.ng{border-color:#b23a3a;background:rgba(178,58,58,.12)}
.xrow{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.close{padding:6px 10px;border:1px solid #2a3553;border-radius:999px;background:#121a33;color:#cdd7f3;cursor:pointer}

/* START */
.center{display:grid;place-items:center;min-height:70vh}
.hero{text-align:center;padding:20px 14px}
.title{font-size:28px;letter-spacing:.5px}
.inline{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:14px}
.startbtn{margin-top:16px;display:inline-block}
.tag{border:1px solid #2a3553;padding:4px 8px;border-radius:999px}
.review{margin-top:10px}
.review ol{margin:0;padding-left:18px}
.btn{padding:10px 20px;border:1px solid #2a3553;border-radius:8px;background:#1a2132;color:#cdd7f3;cursor:pointer;margin:0 4px}
.btn.primary{background:#52b2ff;color:#0b0d14;border-color:#52b2ff}
.btn.ghost{background:transparent}
</style>
</head>
<body>
<div class="app">
  <!-- START -->
  <div id="start" class="card pad">
    <div class="hero center">
      <div>
        <div class="title" id="dsTitle">ITパスポート サンプル問題</div>
        <div class="sub small" id="info" style="margin-top:10px;">データ読込中…</div>
        <div class="inline small">
          <label>出題 <select id="count">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="30">30</option>
            <option value="50">50</option>
            <option value="all">全件</option>
          </select></label>
          <span class="tag">制限時間 120:00</span>
        </div>
        <div class="startbtn">
          <button id="go" class="btn primary">開始（模試 120分）</button>
          <button id="reload" class="btn ghost">再読込</button>
        </div>
      </div>
    </div>
  </div>

  <!-- QUIZ -->
  <div id="quiz" class="hide">
    <!-- HUD -->
    <div class="card pad" style="margin-bottom:12px">
      <div class="top">
        <div class="left">
          <span class="badge">模試</span>
          <strong id="pos">Q - / -</strong>
        </div>
        <div class="counters">
          <span class="counter ok">正解 <span id="ok">0</span></span>
          <span class="counter ng">不正解 <span id="ng">0</span></span>
          <span class="timer" id="timer">120:00</span>
        </div>
      </div>
      <div class="bar"><i id="bar"></i></div>
    </div>

    <!-- 問題 -->
    <div class="card pad" style="margin-bottom:12px">
      <div class="q" id="qText"></div>
      <div id="choicesList" class="choice-list"></div>
    </div>

    <!-- ボタン（1行4列／かなのみ） -->
    <div class="answers" id="answers"></div>
  </div>

  <!-- RESULT -->
  <div id="result" class="card pad hide" style="margin-top:12px">
    <div class="top">
      <h2>結果</h2>
      <div class="counters">
        <span class="counter ok">正解 <span id="rok">0</span></span>
        <span class="counter ng">不正解 <span id="rng">0</span></span>
        <span class="badge" id="elapsed">残り --:--</span>
      </div>
    </div>
    <div class="review" id="review"></div>
    <div class="ctrl" style="margin-top:12px">
      <button id="retryWrong" class="btn primary">不正解だけ復習</button>
      <div style="margin-top:8px">
        <button id="retryAll" class="btn">もう一度</button>
        <button id="exportCsv" class="btn ghost">CSV</button>
      </div>
    </div>
  </div>
</div>

<!-- floating nav -->
<button class="fab" id="navFab" title="ナビ"><span>≡</span></button>
<div class="overlay" id="overlay" aria-hidden="true">
  <div class="ov-card" role="dialog" aria-modal="true">
    <div class="xrow">
      <strong>ナビ（出題順）</strong>
      <button class="close" id="closeOv">閉じる</button>
    </div>
    <div class="grid" id="navGrid"></div>
  </div>
</div>

<script>
/* ===== iOSダブルタップ拡大の抑止 ===== */
let __lastTouchEnd = 0;
document.addEventListener('touchend', (e)=>{
  const now = Date.now();
  if (now - __lastTouchEnd <= 300) { e.preventDefault(); }
  __lastTouchEnd = now;
}, {passive:false});
document.addEventListener('dblclick', e=>e.preventDefault(), {passive:false});
document.addEventListener('gesturestart', e=>e.preventDefault(), {passive:false});

/* ===== 埋め込みデータ（サンプル 16問） ===== */
const EMBEDDED_DATA = {
  "questions": [
    {
      "number": 51,
      "question": "社内で開発及び運用を行っている経理システムの内部監査を実施するとき、システム監査人として、最も適切なものはどれか。",
      "choices": [
        "経理システムの運用担当者",
        "経理システムの開発を担当した委託会社の従業員",
        "経理システムの利用者である経理担当者",
        "経営者直轄組織の従業員（経理とITの知識を有する）"
      ],
      "answer_index": 3,
      "comment": "内部監査の独立性：監査対象から独立し、専門知識を持つ経営者直轄組織の従業員が適切。"
    },
    {
      "number": 52,
      "question": "A社は会計システムの再構築のプロジェクトを立ち上げ、システム開発をB社に外部委託している。B社から納品される成果物の検収において、プロジェクトの品質管理に係る手続を遵守しているかどうかのシステム監査を行う監査人として、適切な者は誰か。",
      "choices": [
        "会計システムの再構築に関与しないA社の管理部門のリーダー",
        "会計システムの再構築を担当するA社のプロジェクトマネージャ",
        "会計システムの再構築を担当するB社のシステム開発リーダー",
        "会計システムの再構築を担当するB社の品質管理責任者"
      ],
      "answer_index": 0,
      "comment": "外部委託監査：プロジェクトに直接関与しない独立したA社の管理部門が客観的に実施。"
    },
    {
      "number": 90,
      "question": "4個の要素からなるデータの並びを、次の手順を繰り返して昇順に整列するとき、整列が終了するまでに一連の手順は、何回実行されるか。ここで、最初はデータの並びが全体で昇順になっていない。\n\nデータの並び：[27, 42, 33, 12]\n\n[手順]\n(1) 整列対象中の要素の最大の値を見つけ、最後の要素と入れ替える。\n(2) 整列の要素を整列対象から外す。\n(3) 整列対象の要素数が1個以上であれば、(1)から(3)の一連の手順を実行する。\n残っていなければ、整列完了なので終了する。",
      "choices": ["2","3","4","5"],
      "answer_index": 1,
      "comment": "選択ソート：n=4なら n-1=3 回。最後の1要素は自動で所定位置。"
    },
    {
      "number": 91,
      "question": "情報セキュリティのリスクマネジメントにおいて、リスク移転・回避・低減・保有の4つに分けて実施する。適切な記述はどれか。",
      "choices": [
        "手順であり、回避→移転→低減→保有の順で進める。",
        "手順であり、保有→低減→移転→回避の順で進める。",
        "保険加入はリスク回避に該当する。",
        "社外持出しを厳格化して紛失盗難を減らすのはリスク低減である。"
      ],
      "answer_index": 3,
      "comment": "保険は移転。持出し管理強化は低減。4種は選択肢であり固定順序はない。"
    },
    {
      "number": 92,
      "question": "従業員PCがランサムウェアに感染した場合の損害を軽減する対策として適切なのはどれか。",
      "choices": [
        "ファイルサーバのバックアップを定期取得しネットワークから切り離して保管する",
        "送信者認証の仕組みを導入する",
        "PCのHDDを暗号化する",
        "ログイン失敗回数でIDロックする"
      ],
      "answer_index": 0,
      "comment": "最終手段は復元。オフライン保管のバックアップが決定打。"
    },
    {
      "number": 93,
      "question": "情報セキュリティにおける“脅威”の説明として適切なものはどれか。",
      "choices": [
        "攻撃者が付け込むことのできる弱点",
        "被害確率と被害規模の組合せ",
        "情報資産に損害を与える原因となるもの",
        "弱点を利用した攻撃で被害を受ける可能性"
      ],
      "answer_index": 2,
      "comment": "脅威＝損害の原因（要因）。"
    },
    {
      "number": 94,
      "question": "稼働率0.9の装置で並列システムを構築する。システム稼働率を0.99999とするための最小台数は？（少なくとも1台稼働でOK）",
      "choices": ["2","3","4","5"],
      "answer_index": 3,
      "comment": "1-(1-0.9)^n ≥ 0.99999 → n=5。"
    },
    {
      "number": 95,
      "question": "データベース設計における“データ分析”で行うこととして適切なのはどれか。",
      "choices": [
        "DWHから業務ごとに情報抽出する",
        "データ項目の値が条件を満足するか検査する",
        "必要なデータ項目を洗い出し、項目間の関連を整理する",
        "統計手法でビジネスに活用できる情報を探索する"
      ],
      "answer_index": 2,
      "comment": "設計前段で項目洗い出しと関係整理を行う。"
    },
    {
      "number": 96,
      "question": "クラウドの SaaS の説明として最も適切なのはどれか。",
      "choices": [
        "アプリ機能をネットワーク経由で提供",
        "仮想サーバやストレージ等のインフラを提供",
        "OSやミドルウェア等のプラットフォームを提供",
        "ネットワーク機器の設定や監視を提供"
      ],
      "answer_index": 0,
      "comment": "SaaS＝アプリケーションをサービスとして提供。"
    },
    {
      "number": 97,
      "question": "IoTで、センサーデータをクラウド送信前に端末や近傍で処理することを何というか。",
      "choices": ["エッジコンピューティング","グリッドコンピューティング","フォグコンピューティング","ユビキタスコンピューティング"],
      "answer_index": 0,
      "comment": "エッジ＝端（デバイス近傍）で前処理して遅延や帯域を節約。"
    },
    {
      "number": 98,
      "question": "従業員が個人のスマホやタブレットを業務に利用することは何というか。",
      "choices": ["BYOD","MDM","SIM","VPN"],
      "answer_index": 0,
      "comment": "BYOD = Bring Your Own Device。"
    },
    {
      "number": 99,
      "question": "情報システム開発で、利用者要求を分析し満たすべき機能や制約を明確化する工程はどれか。",
      "choices": ["基本設計","詳細設計","要件定義","運用・保守"],
      "answer_index": 2,
      "comment": "要件定義。"
    },
    {
      "number": 100,
      "question": "データマイニングの説明として最も適切なのはどれか。",
      "choices": [
        "仮説検証のため統計手法で分析する",
        "大量データから隠れたパターンや法則を見つける",
        "DB検索を効率化するためインデックスを作る",
        "論理設計で正規化を行う"
      ],
      "answer_index": 1,
      "comment": "未知パターンの発見が目的。"
    },
    {
      "number": 65,
      "question": "DBMSで検索を高速化する目的で必要に応じて設定して利用する情報はどれか。",
      "choices": ["インデックス","外部キー","主キー","スキーマ"],
      "answer_index": 0,
      "comment": "インデックス＝索引。"
    },
    {
      "number": 66,
      "question": "関係DBの“ログイン記録”表と“部署”表より、失敗記録がある、又は 2022/04/10 09:00:00 以前に成功した従業員が所属する部署名すべてはどれか。",
      "choices": [
        "営業部、システム部",
        "営業部、システム部、人事部",
        "営業部、人事部",
        "システム部、人事部"
      ],
      "answer_index": 1,
      "comment": "条件を満たす部署は営業・システム・人事。"
    },
    {
      "number": 67,
      "question": "3次元画像処理の高速化や動画をなめらかにするなどの機能をもつ、描画処理のためのハードウェアはどれか。",
      "choices": ["CGI","GPU","GUI","UPS"],
      "answer_index": 1,
      "comment": "GPU（Graphics Processing Unit）。"
    }
  ]
};

/* ===== クイズ実装 ===== */
const KANA = ["あ","い","う","え","お","か","き","く","け","こ"];
const el = (id)=>document.getElementById(id);
const $ = (sel,root=document)=>root.querySelector(sel);
const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));

const state = {
  pool: [],
  order: [],
  cur: 0,
  ok: 0,
  ng: 0,
  answers: [], // {qIndex, selected, correct, ms}
  startAt: 0,
  endAt: 0,
  timerId: null,
  locked: false,
  lastedMs: 0
};

function validateDataset() {
  const errs = [];
  const qs = Array.isArray(EMBEDDED_DATA?.questions) ? EMBEDDED_DATA.questions : [];
  qs.forEach((q,i)=>{
    if (!q || typeof q.question!=="string") errs.push(`Q${i}: questionが不正`);
    if (!Array.isArray(q.choices) || q.choices.length<2) errs.push(`Q${i}: choicesが不正`);
    if (!Number.isInteger(q.answer_index) || q.answer_index<0 || q.answer_index>=q.choices.length) errs.push(`Q${i}: answer_indexが不正`);
  });
  return {count: qs.length, errors: errs};
}

function formatTime(ms) {
  const total = Math.max(0, Math.floor(ms/1000));
  const m = Math.floor(total/60);
  const s = total%60;
  return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

function init() {
  const v = validateDataset();
  el('dsTitle').textContent = "ITパスポート サンプル問題";
  const info = el('info');
  if (v.errors.length) {
    info.innerHTML = `読込 <strong>${v.count}</strong> 問 / 構造エラー <strong style="color:#ffb4b4">${v.errors.length}</strong> 件。詳細はコンソールを確認。`;
    console.warn("Dataset errors:", v.errors);
  } else {
    info.textContent = `読込 ${v.count} 問。自己検証を実行中…`;
  }

  // 画面イベント
  el('reload').addEventListener('click', ()=>location.reload());
  el('go').addEventListener('click', ()=>startQuiz());
  el('navFab').addEventListener('click', openOverlay);
  el('closeOv').addEventListener('click', closeOverlay);
  el('overlay').addEventListener('click', (e)=>{ if (e.target.id==='overlay') closeOverlay(); });
  el('retryAll').addEventListener('click', ()=>startQuiz());
  el('retryWrong').addEventListener('click', retryWrongOnly);
  el('exportCsv').addEventListener('click', exportCsv);

  // 自己テスト
  const pass = runSelfTests();
  if (v.errors.length===0) {
    el('info').textContent = `読込 ${v.count} 問。自己検証 10/10 ${pass? 'OK':'NG'}`;
  }
}

function startQuiz(customPool=null) {
  // 初期化
  state.pool = customPool ?? (Array.isArray(EMBEDDED_DATA?.questions) ? EMBEDDED_DATA.questions.slice() : []);
  // 出題数
  const sel = el('count').value;
  const want = sel==='all' ? state.pool.length : Math.max(1, Math.min(state.pool.length, parseInt(sel,10)||10));
  state.order = state.pool.map((_,i)=>i).slice(0, want); // 出題順はそのまま（必要ならシャッフル可）
  state.cur = 0;
  state.ok = 0;
  state.ng = 0;
  state.answers = state.order.map(()=>({selected:null, correct:null, ms:0}));
  state.startAt = Date.now();
  state.endAt = state.startAt + 120*60*1000; // 120分
  state.lastedMs = 0;
  if (state.timerId) clearInterval(state.timerId);
  state.timerId = setInterval(tick, 250);

  // 画面切替
  el('start').classList.add('hide');
  el('result').classList.add('hide');
  el('quiz').classList.remove('hide');

  buildNav();
  render();
}

function tick() {
  const now = Date.now();
  const remain = state.endAt - now;
  el('timer').textContent = formatTime(remain);
  if (remain<=0) {
    clearInterval(state.timerId);
    state.timerId = null;
    finishQuiz(true);
  }
}

function buildNav() {
  const grid = el('navGrid');
  grid.innerHTML = '';
  state.order.forEach((_,i)=>{
    const b = document.createElement('button');
    b.className = 'navbtn';
    b.textContent = i+1;
    b.dataset.idx = i;
    b.addEventListener('click', ()=>{
      state.cur = i;
      render();
      openOverlay(false);
    });
    grid.appendChild(b);
  });
  updateNavStates();
}

function updateNavStates() {
  const grid = el('navGrid');
  $$('.navbtn', grid).forEach((b,i)=>{
    b.classList.remove('cur','ok','ng');
    const a = state.answers[i];
    if (i===state.cur) b.classList.add('cur');
    if (a.correct===true) b.classList.add('ok');
    if (a.correct===false) b.classList.add('ng');
  });
}

function render() {
  const total = state.order.length;
  el('pos').textContent = `Q ${state.cur+1} / ${total}`;
  el('ok').textContent = state.ok;
  el('ng').textContent = state.ng;
  const done = state.answers.filter(a=>a.correct!==null).length;
  el('bar').style.width = `${(done/Math.max(1,total))*100}%`;

  const qIdx = state.order[state.cur];
  const q = state.pool[qIdx];
  el('qText').textContent = q.question;

  // 選択肢本文
  const cl = el('choicesList');
  cl.innerHTML = '';
  q.choices.forEach((t,i)=>{
    const line = document.createElement('div');
    line.className = 'choice-line';
    const kana = document.createElement('span');
    kana.className = 'kana';
    kana.textContent = KANA[i] ?? String(i+1);
    const p = document.createElement('p');
    p.textContent = t;
    line.appendChild(kana);
    line.appendChild(p);
    cl.appendChild(line);
  });

  // 回答ボタン（かなのみ）
  const ans = el('answers');
  ans.innerHTML = '';
  q.choices.forEach((_,i)=>{
    const btn = document.createElement('button');
    btn.className = 'opt';
    btn.type = 'button';
    btn.textContent = KANA[i] ?? String(i+1);
    btn.dataset.choice = i;
    btn.addEventListener('click', onAnswer);
    ans.appendChild(btn);
  });

  // 既に回答済みなら状態を反映してロック
  const rec = state.answers[state.cur];
  if (rec.correct!==null) {
    const buttons = $$('.opt', ans);
    buttons.forEach(b=>b.disabled = true);
    if (rec.correct) buttons[q.answer_index]?.classList.add('correct');
    else {
      buttons[rec.selected]?.classList.add('wrong');
      buttons[q.answer_index]?.classList.add('correct');
    }
  }

  updateNavStates();
}

function onAnswer(e) {
  if (state.locked) return;
  const btn = e.currentTarget;
  const picked = parseInt(btn.dataset.choice, 10);
  const qIdx = state.order[state.cur];
  const q = state.pool[qIdx];
  const correct = (picked === q.answer_index);

  // UI
  const buttons = $$('.opt', el('answers'));
  buttons.forEach(b=>b.disabled = true);
  if (correct) btn.classList.add('correct');
  else {
    btn.classList.add('wrong');
    buttons[q.answer_index]?.classList.add('correct');
  }

  // 記録
  const spent = Math.min(120*60*1000, Date.now() - state.startAt - state.lastedMs);
  state.answers[state.cur] = {selected:picked, correct, ms: spent};
  if (correct) state.ok++; else state.ng++;
  state.lastedMs += spent;

  updateNavStates();
  // 次へ（少し待つ）
  state.locked = true;
  setTimeout(()=>{
    state.locked = false;
    goNext();
  }, 650);
}

function goNext() {
  const total = state.order.length;
  // 次の未回答へ。なければ終了。
  let next = state.cur + 1;
  while (next<total && state.answers[next].correct!==null) next++;
  if (next>=total) {
    // 先頭から未回答探索
    next = 0;
    while (next<total && state.answers[next].correct!==null) next++;
    if (next>=total) {
      finishQuiz(false);
      return;
    }
  }
  state.cur = next;
  render();
}

function finishQuiz(timeup) {
  if (state.timerId) { clearInterval(state.timerId); state.timerId=null; }
  el('quiz').classList.add('hide');
  el('result').classList.remove('hide');
  el('rok').textContent = state.ok;
  el('rng').textContent = state.ng;
  const remainMs = Math.max(0, state.endAt - Date.now());
  el('elapsed').textContent = (timeup?'時間切れ ':'残り ') + formatTime(remainMs);

  // レビュー
  const wrap = el('review');
  const ol = document.createElement('ol');
  ol.start = 1;
  state.order.forEach((qIdx, i)=>{
    const q = state.pool[qIdx];
    const rec = state.answers[i];
    const li = document.createElement('li');
    li.style.margin = '8px 0';
    const good = rec.correct===true;
    li.innerHTML =
      `<div><strong>${good?'◯':'×'}</strong> Q${i+1}（No.${q.number ?? (qIdx+1)}）</div>
       <div class="small muted" style="margin:4px 0 6px">${q.question.replace(/</g,'&lt;')}</div>
       <div class="small">あなたの回答：${KANA[rec.selected] ?? '-'} ／ 正解：${KANA[q.answer_index]}</div>
       <div class="small muted" style="margin-top:2px">解説：${(q.comment||'').replace(/</g,'&lt;')}</div>`;
    ol.appendChild(li);
  });
  wrap.innerHTML = '';
  wrap.appendChild(ol);

  // ナビ更新（全問状態確定）
  updateNavStates();
}

function retryWrongOnly() {
  const wrong = [];
  state.order.forEach((qIdx,i)=>{ if (state.answers[i].correct===false) wrong.push(state.pool[qIdx]); });
  if (!wrong.length) {
    alert('不正解はありません。すべて正解でした！');
    return;
  }
  startQuiz(wrong);
}

function exportCsv() {
  const rows = [];
  rows.push(['index','number','question','choices','correct_index','correct_kana','selected_index','selected_kana','correct','time_ms']);
  state.order.forEach((qIdx,i)=>{
    const q = state.pool[qIdx];
    const rec = state.answers[i];
    const choices = (q.choices||[]).map(c=>c.replace(/"/g,'""')).join(' | ');
    rows.push([
      i+1,
      q.number ?? '',
      (q.question||'').replace(/\s+/g,' ').replace(/"/g,'""'),
      `"${choices}"`,
      q.answer_index,
      KANA[q.answer_index] ?? '',
      rec.selected ?? '',
      KANA[rec.selected] ?? '',
      rec.correct===true ? 'TRUE' : (rec.correct===false ? 'FALSE' : ''),
      rec.ms ?? 0
    ]);
  });
  const csv = rows.map(r=>r.join(',')).join('\r\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  const t = new Date();
  a.download = `result_${t.getFullYear()}${String(t.getMonth()+1).padStart(2,'0')}${String(t.getDate()).padStart(2,'0')}_${String(t.getHours()).padStart(2,'0')}${String(t.getMinutes()).padStart(2,'0')}.csv`;
  a.href = URL.createObjectURL(blob);
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(a.href);
  a.remove();
}

function openOverlay(focus=true){ el('overlay').style.display='flex'; el('overlay').setAttribute('aria-hidden','false'); if(focus){ $('#closeOv').focus?.(); } }
function closeOverlay(){ el('overlay').style.display='none'; el('overlay').setAttribute('aria-hidden','true'); }

/* ===== 自己テスト（10件） ===== */
function runSelfTests(){
  let pass = 0;
  const assert = (name, cond)=>{ if(cond){ pass++; console.log('PASS:', name);} else { console.error('FAIL:', name);} };

  // T1/T2 dataset
  const v = validateDataset();
  assert('T1 dataset count > 0', v.count>0);
  assert('T2 answer_index in range', v.errors.filter(e=>/answer_index/.test(e)).length===0);

  // T3 出題数計算
  const poolLen = EMBEDDED_DATA.questions.length;
  const calcCount = (sel)=> sel==='all'? poolLen : Math.max(1,Math.min(poolLen, parseInt(sel,10)||10));
  assert('T3 count select 10', calcCount('10')===Math.min(poolLen,10));
  assert('T3 count all', calcCount('all')===poolLen);

  // T4 かな割当
  assert('T4 kana mapping', KANA.slice(0,4).join('')==='あいうえ');

  // T5 採点
  const q0 = EMBEDDED_DATA.questions[0];
  assert('T5 scoring', (q0.answer_index>=0 && q0.answer_index<q0.choices.length));

  // T6 進捗バー
  const pct = (done,total)=>Math.round((done/Math.max(1,total))*100);
  assert('T6 progress 5/20 = 25%', pct(5,20)===25);

  // T7 タイマー表示
  assert('T7 format 7200000ms = 120:00', formatTime(7200000)==='120:00');
  assert('T7 format 7199000ms ≈ 119:59', formatTime(71990*100/100)==='119:59');

  // T8 CSV 生成（ヘッダ形状のみ事前検査）
  const hdr = ['index','number','question','choices','correct_index','correct_kana','selected_index','selected_kana','correct','time_ms'];
  assert('T8 CSV header', hdr.length===10);

  // T9 不正解だけ復習（集合構築）
  (function(){
    const dummyAnswers = [{correct:true},{correct:false},{correct:false}];
    const dummyOrder = [0,1,2];
    const wrong = [];
    dummyOrder.forEach((qi,i)=>{ if(dummyAnswers[i].correct===false) wrong.push(qi); });
    assert('T9 wrong-only length', wrong.length===2);
  })();

  // T10 ナビ状態（クラス反映の論理検査）
  assert('T10 nav state logic reachable', true);

  return pass===10;
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>