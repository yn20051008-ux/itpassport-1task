<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Trainer Minimal</title>
<style>
  :root{
    --bg:#0c1220;--card:#121b2e;--card2:#0f1728;--txt:#e9eefc;
    --muted:#9fb0d6;--accent:#3b82f6;--ok:#22c55e;--ng:#f43f5e;
    --chip:#1b2742;--btn:#19233c;--btn2:#111a30;--ring:#2a3b63;
  }
  html,body{height:100%}
  body{
    margin:0;background:linear-gradient(180deg,#0b1221, #0a1020 60%, #090e1c);
    color:var(--txt);font-family: system-ui, -apple-system, Segoe UI, Roboto, "ヒラギノ角ゴ ProN", "游ゴシック", "Yu Gothic", "Noto Sans JP", sans-serif;
  }
  .wrap{max-width:980px;margin:0 auto;padding:24px 16px 100px}
  .card{background:var(--card);border-radius:20px;padding:20px;border:1px solid #1f2b48;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  h1{font-size:clamp(22px,3.8vw,40px);margin:6px 0 8px;letter-spacing:.02em}
  .muted{color:var(--muted)}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid #223053;background:var(--btn);color:var(--txt);
       padding:12px 16px;border-radius:12px;font-weight:600;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:white}
  .btn.ghost{background:transparent}
  .chip{display:inline-flex;align-items:center;gap:8px;background:var(--chip);color:#cfe1ff;
        padding:8px 12px;border-radius:12px;border:1px solid #24345b}
  .bar{height:10px;border-radius:999px;background:#182442;overflow:hidden;border:1px solid #24345b}
  .bar>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#3b82f6,#60a5fa)}
  .stat{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .stat b.ok{color:var(--ok)} .stat b.ng{color:var(--ng)}
  .qbox{background:var(--card2);border:1px solid #1b2846;border-radius:16px;padding:16px;line-height:1.9}
  .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  @media (max-width:680px){ .grid4{grid-template-columns:repeat(4,1fr)} }
  .opt{background:#0f172a;border:1px solid #203055;border-radius:14px;padding:12px;text-align:center;font-weight:700;letter-spacing:.08em;cursor:pointer}
  .opt.ok{background:rgba(34,197,94,.1);border-color:#22c55e;color:#a6f3c5}
  .opt.wrong{background:rgba(244,63,94,.08);border-color:#f43f5e;color:#ffb9c3}
  .titleRow{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
  .small{font-size:12px}
  .select, input[type="text"], .file{
    width:100%;max-width:520px;background:#0f172a;border:1px solid #223053;color:var(--txt);
    border-radius:12px;padding:12px 14px
  }
  .grid2{display:grid;grid-template-columns:1.2fr 1fr;gap:12px}
  @media (max-width:760px){ .grid2{grid-template-columns:1fr} }
  dialog{border:none;border-radius:16px;background:#0f1729;color:var(--txt);padding:18px 16px}
  dialog::backdrop{background:rgba(0,0,0,.45)}
</style>
</head>
<body>
  <div class="wrap">

    <!-- ========== Home / Top Screen ========== -->
    <section id="home" class="card" style="display:block">
      <h1 id="appTitle">Trainer Minimal</h1>
      <p class="muted" id="homeSubtitle">まずは使うJSONデータを選んでください。</p>

      <div class="qbox" style="margin-top:12px">
        <div class="grid2">
          <div>
            <label class="small muted">候補から選ぶ</label><br>
            <select id="selectJson" class="select"></select>
          </div>
          <div>
            <label class="small muted">任意のJSON URL（同一ドメイン推奨）</label><br>
            <input id="inputUrl" type="text" class="select" placeholder="/data/itpassport_2025r07.json">
          </div>
        </div>

        <div class="row" style="margin-top:10px;align-items:center">
          <label class="btn ghost" style="padding:10px 12px">
            ローカルファイル選択
            <input id="fileInput" type="file" accept="application/json" style="display:none">
          </label>
          <span class="muted small" id="fileName"></span>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="btnLoad">読み込む</button>
          <button class="btn ghost" id="btnReload">再読込</button>
        </div>

        <div id="preview" style="display:none;margin-top:16px">
          <span class="chip">件数プレビュー：<b id="countPreview">0</b> 問</span>
          <span class="chip" id="titlePreview" style="display:none"></span>
          <div class="row" style="margin-top:12px">
            <button class="btn primary" id="btnStart">開始（模試 120分）</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== Exam Screen ========== -->
    <section id="exam" class="card" style="display:none">
      <div class="titleRow">
        <div class="chip">模試</div>
        <div class="muted" id="examTitle">Trainer Minimal</div>
      </div>

      <div class="stat" style="margin-bottom:10px">
        <b>Q <span id="qNow">1</span> / <span id="qTotal">0</span></b>
        <b class="ok">正解 <span id="okCnt">0</span></b>
        <b class="ng">不正解 <span id="ngCnt">0</span></b>
        <span class="chip"><span id="timer">120:00</span></span>
      </div>
      <div class="bar"><i id="bar"></i></div>

      <div class="qbox" style="margin-top:14px">
        <div id="qText"></div>
      </div>

      <div class="grid4" style="margin-top:12px">
        <div class="opt" data-idx="0">ア</div>
        <div class="opt" data-idx="1">イ</div>
        <div class="opt" data-idx="2">ウ</div>
        <div class="opt" data-idx="3">エ</div>
      </div>

      <div id="explain" class="qbox" style="display:none;margin-top:12px"></div>

      <div class="row" style="margin-top:12px;justify-content:flex-end">
        <button class="btn" id="btnBackHome">終了してトップへ</button>
      </div>
    </section>

  </div>

  <dialog id="dlg"><p id="dlgMsg">Message</p><div style="text-align:right"><button class="btn" id="dlgOk">OK</button></div></dialog>

<script>
(() => {
  // ====== 設定（候補のJSON。必要に応じて増やしてください） ======
  const DATA_CANDIDATES = [
    {label:"/data/itpassport_2025r07.json", value:"/data/itpassport_2025r07.json"},
    // 例: {label:"/data/itpassport_2025r04.json", value:"/data/itpassport_2025r04.json"},
  ];

  // ====== 要素 ======
  const elHome = document.getElementById('home');
  const elExam = document.getElementById('exam');
  const sel = document.getElementById('selectJson');
  const inpUrl = document.getElementById('inputUrl');
  const fileInp = document.getElementById('fileInput');
  const fileName = document.getElementById('fileName');
  const btnLoad = document.getElementById('btnLoad');
  const btnReload = document.getElementById('btnReload');
  const prev = document.getElementById('preview');
  const cntPrev = document.getElementById('countPreview');
  const titlePreview = document.getElementById('titlePreview');
  const btnStart = document.getElementById('btnStart');
  const examTitle = document.getElementById('examTitle');

  const qNow = document.getElementById('qNow');
  const qTotal = document.getElementById('qTotal');
  const okCnt = document.getElementById('okCnt');
  const ngCnt = document.getElementById('ngCnt');
  const bar = document.getElementById('bar');
  const qText = document.getElementById('qText');
  const opts = [...document.querySelectorAll('.opt')];
  const explain = document.getElementById('explain');
  const timerSpan = document.getElementById('timer');
  const btnBackHome = document.getElementById('btnBackHome');

  const dlg = document.getElementById('dlg');
  const dlgMsg = document.getElementById('dlgMsg');
  const dlgOk = document.getElementById('dlgOk');
  dlgOk.onclick = () => dlg.close();

  // ====== 状態 ======
  let rawData = null;          // 読み込んだJSON（オブジェクト or 配列）
  let questions = [];          // 正規化後 [{question,choices,answer_index,comment}]
  let idx = 0, ok = 0, ng = 0;
  let deadline = null, timerId = null;

  // ====== ユーティリティ ======
  const showError = (msg) => { dlgMsg.textContent = msg; dlg.showModal(); };
  const cacheBuster = (url) => url + (url.includes('?')?'&':'?') + '_=' + Date.now();

  function saveSource(meta){
    localStorage.setItem('jsonSource', JSON.stringify(meta)); // {type:'url'|'file'|'inline', name, value}
  }
  function loadSource(){
    try { return JSON.parse(localStorage.getItem('jsonSource')||'null'); } catch { return null; }
  }

  // ====== 初期化：候補リスト & 前回選択の復元 ======
  function initHome(){
    sel.innerHTML = DATA_CANDIDATES.map(x=>`<option value="${x.value}">${x.label}</option>`).join('');
    const last = loadSource();
    if(last){
      if(last.type==='url'){ inpUrl.value = last.value; }
      if(last.type==='candidate'){ sel.value = last.value; }
      if(last.type==='file'){ fileName.textContent = last.name + '（ローカル）'; }
    }
  }

  // ====== JSON読み込み & 正規化 ======
  async function loadJson(){
    // 優先順位: ファイル選択 > URL欄 > 候補セレクト
    try{
      let meta = null, data = null;

      if(fileInp.files && fileInp.files[0]){
        const f = fileInp.files[0];
        data = JSON.parse(await f.text());
        meta = {type:'file', name:f.name, value:'localfile'};
        saveSource(meta);
      } else {
        let url = (inpUrl.value || '').trim() || sel.value;
        if(!url){ showError('JSONの場所を選択してください。'); return; }
        // 相対パスはそのまま。キャッシュバスター付与
        const res = await fetch(cacheBuster(url));
        if(!res.ok){ showError(`読み込み失敗：${res.status} (${url})`); return; }
        data = await res.json();
        meta = {type:(inpUrl.value.trim()? 'url':'candidate'), name:url, value:url};
        saveSource(meta);
      }

      rawData = data;
      questions = normalizeToQ(data);
      if(!questions.length){ showError('出題できる問題がありません。'); return; }

      // プレビュー
      cntPrev.textContent = String(questions.length);
      const title = (data && (data.title || data.comment)) ? (data.title || data.comment) : '';
      if(title){ titlePreview.style.display='inline-flex'; titlePreview.textContent = title; }
      else{ titlePreview.style.display='none'; }
      prev.style.display = 'block';

    }catch(e){
      console.error(e);
      showError('JSONの解析に失敗しました。フォーマットをご確認ください。');
    }
  }

  // 受け入れ可能な形に正規化
  function normalizeToQ(data){
    if(!data) return [];
    let arr = [];
    // ① {questions:[...]} 形式
    if(Array.isArray(data.questions)) arr = data.questions;
    // ② 配列そのもの
    else if(Array.isArray(data)) arr = data;
    // ③ ネストが深い場合（questions.questions）
    else if(data.questions && Array.isArray(data.questions.questions)) arr = data.questions.questions;

    // ④ 退避：choicesが文字列1本の「本文に選択肢含める型」も許容（このアプリでは本文に出す）
    return arr.map((q,i) => {
      let choices = q.choices;
      if(!Array.isArray(choices) || choices.length===0){
        // ない場合は本文から "(ア) xxx" を抽出…まではやらず、ダミー4択にする
        choices = ["ア","イ","ウ","エ"];
      }
      // プレフィックス除去（【ア】など）
      const clean = choices.map(t => String(t).replace(/^[\s【\(\[]?[ア-エ]\s*[\]】\)]?\s*/,'').trim());
      return {
        number: q.number ?? (i+1),
        question: String(q.question||'').trim(),
        choices: clean.length>=4 ? clean.slice(0,4) : (clean.concat(["","", "", ""]).slice(0,4)),
        answer_index: Number.isInteger(q.answer_index)? q.answer_index : 0,
        comment: q.comment || ''
      };
    }).filter(x => x.question && x.choices.every(s=>typeof s==='string'));
  }

  // ====== 試験開始 ======
  function startExam(){
    if(!questions.length){ showError('先に「読み込む」を押してください。'); return; }
    // 状態初期化
    idx=0; ok=0; ng=0;
    okCnt.textContent='0'; ngCnt.textContent='0';
    qTotal.textContent=String(questions.length);
    updateBar();

    // タイトル
    const t = (rawData && (rawData.title || rawData.comment))? (rawData.title || rawData.comment) : 'Trainer Minimal';
    examTitle.textContent = t;

    // タイマー 120分
    deadline = Date.now() + 120*60*1000;
    if(timerId) clearInterval(timerId);
    timerId = setInterval(tick, 500);
    tick();

    // 画面遷移
    elHome.style.display='none';
    elExam.style.display='block';

    render();
  }

  function tick(){
    const left = Math.max(0, deadline - Date.now());
    const m = Math.floor(left/60000), s = Math.floor((left%60000)/1000);
    timerSpan.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    if(left<=0){ clearInterval(timerId); timerId=null; }
  }

  function updateBar(){
    const ratio = (idx)/Math.max(1,questions.length);
    bar.style.width = (ratio*100)+'%';
  }

  function render(){
    const q = questions[idx];
    qNow.textContent = String(idx+1);
    updateBar();
    // 本文（選択肢本文も含めたい場合はここで合成）
    const choiceLines = ['ア','イ','ウ','エ'].map((k,i)=>`${k}　${q.choices[i]||''}`).join('\n');
    qText.textContent = `${q.question}\n\n${choiceLines}`;
    // ボタン表記はアイウエのみ（高速押下）
    opts.forEach(opt=>{
      opt.classList.remove('ok','wrong');
    });
    explain.style.display='none';
    explain.textContent='';
  }

  function judge(chosen){
    const q = questions[idx];
    const correct = q.answer_index|0;
    if(chosen===correct){ ok++; okCnt.textContent=String(ok); opts[chosen].classList.add('ok'); }
    else { ng++; ngCnt.textContent=String(ng); opts[chosen].classList.add('wrong'); opts[correct].classList.add('ok'); }
    // 解説
    if(q.comment){ explain.style.display='block'; explain.textContent = '解説：' + q.comment; }

    // 次へ（自動）
    setTimeout(()=>{
      idx++;
      if(idx>=questions.length){
        // 終了
        showError(`終了：正解 ${ok} ／ 不正解 ${ng}`);
        return;
      }
      render();
    }, 420);
  }

  // ====== イベント ======
  btnLoad.onclick = loadJson;
  btnReload.onclick = () => { prev.style.display='none'; loadJson(); };
  btnStart.onclick = startExam;
  fileInp.onchange = () => { fileName.textContent = fileInp.files[0]? fileInp.files[0].name : ''; inpUrl.value=''; };

  opts.forEach(el=>{
    el.addEventListener('click', ()=> judge(Number(el.dataset.idx)));
  });

  btnBackHome.onclick = () => {
    elExam.style.display='none';
    elHome.style.display='block';
    if(timerId) clearInterval(timerId);
  };

  // 起動
  initHome();
  // 自動で前回ソースを試し読み（任意）
  // const last = loadSource(); if(last) btnLoad.click();
})();
</script>
</body>
</html>