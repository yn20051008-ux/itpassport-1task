<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ITパス反復練習</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="format-detection" content="telephone=no" />
  <style>
    :root{
      --bg:#0f1216; --card:#171b21; --muted:#8ea0b5; --text:#e7edf5;
      --ok:#16a34a; --ng:#ef4444; --primary:#3b82f6; --chip:#223045;
      --chip2:#253248; --shadow:0 6px 18px rgba(0,0,0,.25);
      --radius:16px;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      margin:0;background:linear-gradient(180deg,#0f1216 0%,#0b0e12 100%);
      color:var(--text); font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      -webkit-text-size-adjust:100%;
      touch-action:manipulation;
    }
    .container{max-width:880px;margin:0 auto;padding:20px}
    .title{font-size:clamp(20px,4.8vw,28px);font-weight:800;letter-spacing:.04em}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin:10px 0 16px}
    .chip{
      background:var(--chip);border:1px solid #2a3b55;border-radius:999px;
      padding:8px 14px;display:inline-flex;gap:8px;align-items:center;font-weight:700
    }
    .chip.ok{background:#0f2a1a;border-color:#184b2c;color:#b6f3c9}
    .chip.ng{background:#2a1113;border-color:#5a1f25;color:#ffc9cd}
    .chip.time{background:#0f2239;border-color:#1c3f6a;color:#cfe2ff}
    .label{color:var(--muted);font-size:14px;margin-right:6px}
    select.btn,button.btn{
      background:var(--chip2);border:1px solid #2b3a55;color:var(--text);
      padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer
    }
    select.btn{min-width:88px}
    button.btn.primary{background:#2454a8;border-color:#2d63c3}
    button.btn.ghost{background:transparent;border-color:#384b6d}
    .panel{
      background:var(--card);border:1px solid #1f2530;border-radius:var(--radius);
      box-shadow:var(--shadow); padding:18px
    }
    .muted{color:var(--muted)}
    .big{font-size:22px;font-weight:800}
    .hidden{display:none !important}
    .space{height:14px}

    /* 問題表示 */
    .qhead{display:flex;gap:10px;align-items:baseline;margin-bottom:10px}
    .qno{font-weight:800}
    .orig{color:var(--muted);font-size:14px}
    .question-text,.choice-text,.result-summary,.header-stats,.title{
      overflow-wrap:anywhere;word-break:normal;
    }
    .question-text{font-size:clamp(14px,2.6vw,18px);line-height:1.6;margin:8px 0 12px}
    .choice-list{margin:0;padding-left:1.2em}
    .choice-list li{
      margin:6px 0; line-height:1.55; font-size:clamp(13px,2.4vw,17px);
    }

    /* 選択ボタン（A/B/C/D） */
    .option-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:14px}
    .optBtn{
      display:flex;align-items:center;justify-content:center;
      border-radius:12px;padding:12px 0;font-weight:800;letter-spacing:.06em;
      background:#1f2837;border:1px solid #2f3d57;cursor:pointer;user-select:none
    }
    .optBtn:active{transform:translateY(1px)}
    .optBtn.ok{background:#0d3a23;border-color:#1f6d47;color:#c6f7d8}
    .optBtn.ng{background:#3a1113;border-color:#6d1f27;color:#ffd6d9}

    /* 結果 */
    .result-card h3{margin:0 0 10px;font-size:clamp(16px,3vw,20px)}
    .result-summary{font-size:clamp(14px,2.4vw,18px);line-height:1.5}

    /* レイアウト微整 */
    @media (max-width:420px){
      .row{gap:8px}
      .chip{padding:7px 12px}
      .option-grid{gap:8px}
      .optBtn{padding:10px 0}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="title">ITパス反復練習</div>

    <!-- ヘッダー統計 -->
    <div class="row" id="headerRow">
      <span class="chip ok">正解 <span class="big" id="scoreOK">0</span></span>
      <span class="chip ng">不正解 <span class="big" id="scoreNG">0</span></span>
      <span class="chip time">残り <span class="big" id="timeLeft">--:--</span></span>
    </div>

    <!-- 設定パネル -->
    <div class="panel" id="setup">
      <div class="row">
        <span class="label">出題数：</span>
        <select id="countSel" class="btn">
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="30">30</option>
          <option value="50">50</option>
          <option value="80">80</option>
          <option value="100" selected>100</option>
        </select>
        <span class="label">問</span>

        <span class="label" style="margin-left:14px">制限時間：</span>
        <select id="limitMin" class="btn">
          <option value="20">20</option>
          <option value="40">40</option>
          <option value="60">60</option>
          <option value="90">90</option>
          <option value="120" selected>120</option>
        </select>
        <span class="label">分</span>

        <button id="startBtn" class="btn primary">開始する</button>
      </div>
      <div class="muted">ショートカット：<b>1–4</b>（A/B/C/D） / Enter=次へ（自動進行）</div>
    </div>

    <!-- 問題パネル -->
    <div class="panel hidden" id="quiz">
      <div class="qhead">
        <div class="qno" id="qNo">Q — / —</div>
        <div class="orig" id="origNo"></div>
      </div>
      <div class="question-text" id="qText"></div>
      <ol class="choice-list" id="choiceList"></ol>
      <div class="option-grid" id="optGrid">
        <button class="optBtn" data-idx="0" id="btnA">A</button>
        <button class="optBtn" data-idx="1" id="btnB">B</button>
        <button class="optBtn" data-idx="2" id="btnC">C</button>
        <button class="optBtn" data-idx="3" id="btnD">D</button>
      </div>
      <div class="space"></div>
      <div class="muted" id="infoLine"></div>
    </div>

    <!-- 結果パネル -->
    <div class="panel hidden result-card" id="result">
      <h3>終了</h3>
      <div class="result-summary" id="resultSummary"></div>
      <div class="space"></div>
      <button id="retry" class="btn">もう一度</button>
    </div>
  </div>

  <!-- ▼▼ ここに“元データ：配列だけ”を貼る（例：[ {…}, {…} ] ） ▼▼ -->
  <script id="raw-data" type="application/json">[  ]</script>
  <!-- ▲▲ ここに“元データ”を貼る ▲▲ -->

  <script>
    "use strict";

    // --- データ読み込み ---
    function loadRaw(){
      const el = document.getElementById("raw-data");
      if(!el){ alert("データ領域（#raw-data）が見つかりません。"); return []; }
      let json = el.textContent.trim();
      if(!json){ return []; }
      try{
        const data = JSON.parse(json);
        if(!Array.isArray(data)) throw new Error("JSONは配列ではありません");
        return data;
      }catch(e){
        console.error(e);
        alert("問題データのJSONが壊れています。配列だけを貼ってください。");
        return [];
      }
    }

    // --- 状態 ---
    const state = {
      bank: [],           // 全問題
      deck: [],           // 出題順
      total: 0,
      idx: 0,
      ok: 0,
      ng: 0,
      timer:null,
      remainSec: 0,
      locked:false
    };

    // --- ユーティリティ ---
    const $ = sel => document.querySelector(sel);
    const btns = ["#btnA","#btnB","#btnC","#btnD"].map(s=>$(s));

    function fmtTime(sec){
      const m = Math.floor(sec/60), s = sec%60;
      return String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");
    }

    // --- 画面制御 ---
    function showSetup(show){
      $("#setup").classList.toggle("hidden", !show);
      $("#quiz").classList.toggle("hidden", show);
      $("#result").classList.add("hidden");
      $("#startBtn").classList.toggle("hidden", !show); // 開始後は隠す
    }
    function showQuiz(){
      $("#quiz").classList.remove("hidden");
      $("#result").classList.add("hidden");
    }
    function showResult(){
      $("#quiz").classList.add("hidden");
      $("#result").classList.remove("hidden");
    }

    function buildDeck(count){
      // 1→100の順で出す（データの順を尊重）
      const arr = state.bank.slice(0);
      // numberで昇順ソート（numberが無いものは元順）
      arr.sort((a,b)=> (a.number??0) - (b.number??0));
      return arr.slice(0, count);
    }

    function startQuiz(){
      const all = loadRaw();
      if(all.length===0){
        alert('問題データがありません。<script id="raw-data"> に配列を貼ってください。');
        return;
      }
      state.bank = all;
      const count = parseInt($("#countSel").value,10);
      state.deck = buildDeck(Math.min(count, all.length));
      state.total = state.deck.length;
      state.idx = 0; state.ok = 0; state.ng = 0;
      $("#scoreOK").textContent = state.ok;
      $("#scoreNG").textContent = state.ng;

      // タイマー
      const min = parseInt($("#limitMin").value,10);
      state.remainSec = min*60;
      updateTime(); clearInterval(state.timer);
      state.timer = setInterval(()=>{
        state.remainSec--;
        updateTime();
        if(state.remainSec<=0){ clearInterval(state.timer); finishQuiz(); }
      },1000);

      showSetup(false);
      showQuiz();
      renderQuestion();
    }

    function updateTime(){
      $("#timeLeft").textContent = fmtTime(Math.max(0,state.remainSec));
    }

    function renderQuestion(){
      state.locked=false;
      const i = state.idx, q = state.deck[i];
      $("#qNo").textContent = `Q ${i+1} / ${state.total}`;
      $("#origNo").textContent = q.number!=null ? `(元番号: ${q.number})` : "";
      $("#qText").textContent = q.question || "";
      // 選択肢（本文はカード内に表示）
      const ol = $("#choiceList");
      ol.innerHTML = "";
      (q.choices||[]).slice(0,4).forEach((c,idx)=>{
        const li = document.createElement("li");
        li.className = "choice-text";
        li.textContent = `${c}`;
        ol.appendChild(li);
      });
      // ボタン状態リセット
      btns.forEach(b=>{
        b.classList.remove("ok","ng");
        b.disabled = false;
      });
      $("#infoLine").textContent = "";
    }

    function answer(idx){
      if(state.locked) return;
      state.locked=true;
      const q = state.deck[state.idx];
      const correct = (idx === (q.answer_index|0));
      const btn = btns[idx];
      if(btn){ btn.classList.add(correct?"ok":"ng"); }
      if(correct){ state.ok++; $("#scoreOK").textContent = state.ok; }
      else{ state.ng++; $("#scoreNG").textContent = state.ng; }
      // 正解ボタンも軽く光らせる
      const rightBtn = btns[q.answer_index|0];
      if(rightBtn && rightBtn!==btn){ rightBtn.classList.add("ok"); }

      // 解説を一瞬表示（必要なければ消してOK）
      if(q.comment){
        $("#infoLine").textContent = q.comment;
      }

      // 自動で次へ
      setTimeout(()=>{
        next();
      }, 550);
    }

    function next(){
      if(state.idx < state.total-1){
        state.idx++;
        renderQuestion();
      }else{
        finishQuiz();
      }
    }

    function finishQuiz(){
      clearInterval(state.timer);
      const sum = `正解 <b>${state.ok}</b> / 不正解 <b>${state.ng}</b> / 合計 <b>${state.total}</b>`;
      $("#resultSummary").innerHTML = `<p class="muted">おつかれさまでした。</p><p>${sum}</p>`;
      showResult();
      $("#startBtn").classList.remove("hidden"); // 次の開始ボタンは結果では不要なので隠したままでもOK
    }

    // --- イベント ---
    $("#startBtn").addEventListener("click", startQuiz);
    $("#retry").addEventListener("click", ()=>{ showSetup(true); });

    btns.forEach(b=>{
      b.addEventListener("click", e=>{
        const idx = parseInt(e.currentTarget.getAttribute("data-idx"),10);
        answer(idx);
      });
    });

    // キー操作：1-4がA-Dに対応、Enter=次へ（必要時）
    window.addEventListener("keydown",(e)=>{
      if($("#quiz").classList.contains("hidden")) return;
      if(e.key>="1" && e.key<="4"){
        e.preventDefault();
        answer(parseInt(e.key,10)-1);
      }else if(e.key==="Enter"){
        e.preventDefault();
        if(state.locked) next();
      }
    });

    // iOSのピンチ/ダブルタップ拡大をできるだけ無効化
    document.addEventListener('gesturestart', e => e.preventDefault());
  </script>
</body>
</html>
