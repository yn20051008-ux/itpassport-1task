<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ITパス反復練習</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <style>
    :root{
      --bg:#0f1115;
      --card:#171a21;
      --ink:#e8ecf1;
      --muted:#9aa3af;
      --accent:#7dd3fc;
      --ok:#22c55e;
      --ng:#ef4444;
      --btn:#0b0e13;
      --btn2:#222733;
      --shadow:0 8px 24px rgba(0,0,0,.35);
      --gap:14px;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", Arial, sans-serif;
      color:var(--ink);
      background:radial-gradient(1200px 800px at 80% -50%, #1f2330 0%, #0f1115 60%) fixed;
      letter-spacing:.2px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .wrap{
      max-width:900px;
      margin:0 auto;
      padding:22px 16px 28px;
    }

    /* Top (setup) */
    .hero{
      display:grid;
      gap:var(--gap);
    }
    .title{
      font-weight:700;
      line-height:1.15;
      font-size: clamp(22px, 4.6vw, 36px);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .title .pill{
      font-size:12px;
      color:#0b1320;
      background:linear-gradient(180deg, #a5f3fc, #38bdf8);
      padding:5px 8px;
      border-radius:999px;
      letter-spacing:.4px;
    }
    .panel{
      background:linear-gradient(180deg, #1b202b, #131722);
      border:1px solid #293042;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }
    .row{
      display:grid;
      gap:10px;
    }
    @media (min-width:640px){
      .row{ grid-template-columns: 1fr 1fr; }
    }
    .field{display:grid; gap:8px;}
    label{color:var(--muted); font-size:13px;}
    select{
      width:100%;
      background:var(--btn2);
      color:var(--ink);
      border:1px solid #2a3040;
      border-radius:12px;
      padding:14px 12px;
      font-size:16px;
      outline:none;
    }
    .actions{
      display:flex; gap:10px; justify-content:space-between; align-items:center; margin-top:10px;
    }
    .btn{
      appearance:none;
      background:linear-gradient(180deg,#222938,#1a1f2d);
      border:1px solid #2c3346;
      color:#fff;
      padding:14px 18px;
      border-radius:12px;
      font-weight:600;
      font-size:16px;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.35), inset 0 -1px 0 rgba(255,255,255,.04);
      transition:transform .06s ease, opacity .2s ease, background .2s ease;
      width:100%;
      text-align:center;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(1px)}
    .btn-primary{
      background:linear-gradient(180deg,#2a3246,#1d2333);
      border-color:#3a465f;
    }

    /* Quiz bar */
    .bar{
      display:none;
      grid-template-columns:1fr auto auto;
      gap:10px;
      align-items:center;
      margin:8px 0 16px;
    }
    .stat{
      display:flex; gap:8px; align-items:center; font-size:14px; color:var(--muted);
    }
    .badge{
      font-weight:700;
      padding:4px 8px;
      border-radius:9px;
      border:1px solid #2b3244;
      background:#151826;
      color:var(--ink);
      min-width:28px; text-align:center;
    }
    .ok{ color:var(--ok); border-color:#1f3b29; background:rgba(34,197,94,.12) }
    .ng{ color:var(--ng); border-color:#3b1f1f; background:rgba(239,68,68,.12) }
    .time{
      font-variant-numeric: tabular-nums;
      font-weight:700;
      padding:8px 10px;
      border-radius:11px;
      background:linear-gradient(180deg,#1b2130,#141a26);
      border:1px solid #2b3347;
      box-shadow:var(--shadow);
    }

    /* Card */
    .card{
      display:none;
      background:linear-gradient(180deg, #161a24 0%, #0f131c 100%);
      border:1px solid #283043;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }
    .qhead{
      display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:10px;
      color:var(--muted);
      font-size:13px;
    }
    .qtext{
      font-size: clamp(16px, 3.8vw, 20px);
      line-height:1.6;
      margin: 4px 0 10px;
      word-break: break-word;
      white-space: pre-wrap;
    }
    .choices{
      display:grid;
      gap:10px;
      margin: 8px 0 12px;
    }
    .opt{
      display:grid;
      grid-template-columns: 28px 1fr;
      gap:10px;
      align-items:flex-start;
      padding:10px 12px;
      border:1px dashed #2a3144;
      border-radius:12px;
      background:#131826;
      min-height:44px;
      user-select:none;
    }
    .opt .k{ 
      width:24px; height:24px; 
      border-radius:7px; 
      display:flex; align-items:center; justify-content:center;
      background:#0f1420; border:1px solid #293044; 
      font-weight:700; font-size:12.5px; color:var(--muted);
      margin-top:2px;
    }
    .opt .t{ font-size:15px; color:var(--ink); opacity:.92 }

    /* 4-key buttons (ア/イ/ウ/エ) */
    .keyrow{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin-top:8px;
    }
    .key{
      appearance:none;
      border:none;
      background:linear-gradient(180deg,#22283a,#171c2b);
      border:1px solid #343b52;
      color:#ffffff; /* ← 白で固定（「黒くて見えない」問題の再発防止） */
      padding:14px 0;
      border-radius:12px;
      font-weight:800;
      letter-spacing:.1em;
      font-size:16px;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.35), inset 0 -1px 0 rgba(255,255,255,.04);
      transition:transform .06s ease, background .18s ease, border-color .18s ease;
      user-select:none;
      -webkit-user-select:none;
      touch-action: manipulation;
    }
    .key:active{ transform: translateY(1px); }
    .key:focus-visible{ outline:2px solid var(--accent); outline-offset:2px }

    /* feedback flash (speedy, unobtrusive) */
    .flash-ok{ animation:flashOk .45s ease }
    .flash-ng{ animation:flashNg .45s ease }
    @keyframes flashOk{
      0%{ box-shadow:0 0 0 0 rgba(34,197,94,.0); }
      20%{ box-shadow:0 0 0 8px rgba(34,197,94,.18); }
      100%{ box-shadow:0 0 0 0 rgba(34,197,94,.0); }
    }
    @keyframes flashNg{
      0%{ box-shadow:0 0 0 0 rgba(239,68,68,.0); }
      20%{ box-shadow:0 0 0 8px rgba(239,68,68,.18); }
      100%{ box-shadow:0 0 0 0 rgba(239,68,68,.0); }
    }

    /* result */
    .result{
      display:none;
      text-align:center;
      padding:22px 16px;
    }
    .result h2{ margin:0 0 8px; font-size:20px }
    .result .big{
      font-variant-numeric: tabular-nums;
      font-size: clamp(24px, 6vw, 36px);
      font-weight:800;
      margin:4px 0 14px;
    }

    /* compact for iPhone – keep one-screen task */
    @media (max-width:430px){
      .wrap{ padding-top:16px }
      .title{ font-size:26px }
      .opt{ padding:9px 10px }
      .qtext{ font-size:16px }
      .key{ padding:12px 0; font-size:15px }
      .time{ padding:7px 9px }
    }
  </style>
</head>
<body>
<div class="wrap">

  <!-- Setup (トップ画面) -->
  <div id="setup" class="hero">
    <div class="title">
      ITパス反復練習
      <span class="pill">シンプル × クール × スピード</span>
    </div>

    <div class="panel">
      <div class="row">
        <div class="field">
          <label for="qcount">出題数</label>
          <select id="qcount">
            <!-- 規定値 100 -->
            <option value="5">5問</option>
            <option value="10">10問</option>
            <option value="20">20問</option>
            <option value="50">50問</option>
            <option value="100" selected>100問（規定）</option>
          </select>
        </div>
        <div class="field">
          <label for="limit">制限時間</label>
          <select id="limit">
            <!-- 規定値 120分 -->
            <option value="5">5分</option>
            <option value="10">10分</option>
            <option value="15">15分</option>
            <option value="30">30分</option>
            <option value="60">60分</option>
            <option value="90">90分</option>
            <option value="120" selected>120分（規定）</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button id="start" class="btn btn-primary">開始</button>
      </div>
    </div>

    <div class="panel" style="margin-top:10px">
      <div style="font-size:13px; color:var(--muted); line-height:1.7">
        問題データはこのファイルの末尾にある
        <code>&lt;script id="raw-data" type="application/json"&gt;</code> の中に
        <strong>あなたの手元のデータをそのまま</strong> コピペしてください。
        <br>配列 <code>[{…},{…}]</code> でも、<code>{…},{…}</code> 連結でもOK。自動で補正して読み込みます。
      </div>
    </div>
  </div>

  <!-- Quiz bar -->
  <div id="bar" class="bar">
    <div class="stat">
      <span class="badge">Q<span id="qq">1</span>/<span id="qt">0</span></span>
      <span class="badge ok">✔ <span id="ok">0</span></span>
      <span class="badge ng">✖ <span id="ng">0</span></span>
    </div>
    <div class="time" id="timer">--:--</div>
    <div class="stat" id="progressNote" aria-live="polite"></div>
  </div>

  <!-- Question card -->
  <div id="card" class="card" role="group" aria-label="問題">
    <div class="qhead">
      <div id="qno">第 1 問</div>
      <div id="qcat"></div>
    </div>
    <div id="qtext" class="qtext"></div>

    <div class="choices" id="choices">
      <!-- 選択肢の本文（ア/イ/ウ/エ）はここに行として表示。 -->
    </div>

    <!-- 1行4列の小型ボタン（ア/イ/ウ/エ）。本文はボタンに入れず、上のカード内に表示 -->
    <div class="keyrow">
      <button class="key" data-k="0" aria-label="ア">ア</button>
      <button class="key" data-k="1" aria-label="イ">イ</button>
      <button class="key" data-k="2" aria-label="ウ">ウ</button>
      <button class="key" data-k="3" aria-label="エ">エ</button>
    </div>
  </div>

  <!-- Result -->
  <div id="result" class="result panel">
    <h2>結果</h2>
    <div class="big"><span id="scoreOk">0</span> / <span id="scoreTotal">0</span></div>
    <div style="color:var(--muted); margin-bottom:14px">（不正解 <span id="scoreNg">0</span>）</div>
    <button id="retry" class="btn">もう一度</button>
  </div>

</div>

<!-- ↓↓↓ ここにあなたの問題データをコピペしてください（そのままでOK） ↓↓↓
  例）
  {
    "number": 1,
    "question": "・・・・",
    "choices": ["A","B","C","D"],
    "answer_index": 2,
    "comment": "・・・・"
  },
  {
    "number": 2,
    "question": "・・・・",
    "choices": ["A","B","C","D"],
    "answer_index": 0,
    "comment": "・・・・"
  }
  ※ 配列 [] で囲まれていなくても読み込めます（自動で補正します）
-->
<script id="raw-data" type="application/json">
</script>
<!-- ↑↑↑ ここまで（空でもOK） ↑↑↑ -->

<script>
/* ==== 小さなユーティリティ ==== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

/* ==== データ読込（あなたの生データをそのまま貼ってOK） ==== */
function parseRawData() {
  const el = document.getElementById('raw-data');
  if(!el) return [];
  let raw = el.textContent || el.innerText || "";
  raw = raw.trim();

  if(!raw) return []; // 空なら空配列

  // 安全側：scriptタグ終端の紛れをエスケープ（念のため）
  raw = raw.replace(/<\/script>/gi, '<\\/script>');

  // 1) すでに JSON オブジェクト {"questions":[...]} なら取り出す
  try{
    const j = JSON.parse(raw);
    if (Array.isArray(j)) return j;
    if (Array.isArray(j.questions)) return j.questions;
    if (Array.isArray(j.questions_mixed)) return j.questions_mixed;
  }catch(_e){
    // 続行（下の補正ルートで処理）
  }

  // 2) "{...},{...}" のような連結 → 配列に包む
  // 末尾のカンマを除去
  raw = raw.replace(/,\s*$/,'').trim();

  // 先頭/末尾が [] でなければ足す
  if(!(raw.startsWith('[') && raw.endsWith(']'))){
    raw = `[${raw}]`;
  }

  // "]" の直前に余計なカンマがあるケースを修正
  raw = raw.replace(/,\s*\]/g,']');

  // JSON として最終パース
  try{
    const arr = JSON.parse(raw);
    if (Array.isArray(arr)) return arr;
  }catch(e){
    alert('問題データの読み込みに失敗しました。\nJSON の形式（ダブルクォートやカンマ）をご確認ください。\n\nエラー: ' + e.message);
  }
  return [];
}

/* ==== 状態 ==== */
let all = [];          // 全問題（読み込み後）
let qs = [];           // 今回出題セット
let qi = 0;            // 現在のインデックス
let ok = 0;            // 正解数
let ng = 0;            // 不正解数
let timeLeft = 0;      // 秒
let timerId = null;
let locked = false;    // 二重タップ対策＆連打防止

/* ==== UI エントリ ==== */
const setup = $('#setup');
const bar = $('#bar');
const card = $('#card');
const result = $('#result');

const qq = $('#qq');
const qt = $('#qt');
const domOk = $('#ok');
const domNg = $('#ng');
const timer = $('#timer');
const qno = $('#qno');
const qtext = $('#qtext');
const choicesBox = $('#choices');

/* ==== ダブルタップ拡大の抑止（iOS） ==== */
let lastTouchEnd = 0;
document.addEventListener('touchend', function(e) {
  const now = Date.now();
  if (now - lastTouchEnd <= 350) {
    e.preventDefault();
  }
  lastTouchEnd = now;
}, {passive:false});

/* ==== タイマー ==== */
function startTimer(totalMin){
  stopTimer();
  timeLeft = Math.floor(totalMin * 60);
  tick(); // すぐ表示
  timerId = setInterval(tick, 1000);
}
function stopTimer(){
  if(timerId){ clearInterval(timerId); timerId = null; }
}
function fmt(sec){
  const m = Math.floor(sec/60);
  const s = sec%60;
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
function tick(){
  timer.textContent = fmt(timeLeft);
  if(timeLeft<=0){
    stopTimer();
    finish();
  }else{
    timeLeft--;
  }
}

/* ==== 出題準備 ==== */
function shuffle(a){
  for (let i=a.length-1;i>0;i--){
    const j = (Math.random()*(i+1))|0;
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function normalizeItem(item, idx){
  // 最低限のプロパティを保証
  const number = item.number ?? (idx+1);
  const question = String(item.question ?? '');
  const choices = Array.isArray(item.choices) ? item.choices.slice(0,4) : [];
  const answer_index = clamp(Number(item.answer_index ?? 0), 0, 3);
  const comment = item.comment ?? '';
  return { number, question, choices, answer_index, comment };
}

/* ==== 画面制御 ==== */
function show(el){ el.style.display = ''; }
function hide(el){ el.style.display = 'none'; }

function startQuiz(){
  // 設定
  const count = Number($('#qcount').value);
  const minutes = Number($('#limit').value);

  // データ読込
  all = parseRawData().map(normalizeItem);
  if (all.length === 0){
    alert('問題データが見つかりません。\nこのファイル末尾の <script id="raw-data"> の中に、あなたの問題データをコピペしてください。');
    return;
  }

  // 並び順：number があれば 1→100 にソート（ご要望）
  all.sort((a,b)=> (a.number||0)-(b.number||0));

  // 出題抽出
  const pool = all.slice(); // 今は順番維持。ランダムにしたい場合は shuffle(pool)
  qs = pool.slice(0, Math.min(count, pool.length));

  // 状態初期化
  qi = 0;
  ok = 0;
  ng = 0;

  // UI
  hide(setup);            // ← 開始ボタンを含むセットアップは非表示（「始まっても残る」問題の解消）
  show(bar);
  show(card);
  hide(result);

  qt.textContent = String(qs.length);
  domOk.textContent = '0';
  domNg.textContent = '0';

  // タイマー開始（規定値は 120 分）
  startTimer(minutes);

  render();
}

function render(){
  const it = qs[qi];
  if (!it){ finish(); return; }

  qq.textContent = String(qi+1);
  qno.textContent = `第 ${it.number ?? (qi+1)} 問`;
  qtext.textContent = it.question ?? '';

  // 選択肢本文（ア/イ/ウ/エ）をカード内にテキストとして配置（ボタンには入れない）
  const kana = ['ア','イ','ウ','エ'];
  choicesBox.innerHTML = '';
  (it.choices || []).forEach((t, i)=>{
    const row = document.createElement('div');
    row.className = 'opt';
    row.innerHTML = `<div class="k">${kana[i]}</div><div class="t">${t ?? ''}</div>`;
    // 行自体もタップで回答（ボタン不要の操作もサポート。ワンタップ想定）
    row.addEventListener('click', ()=> answer(i));
    choicesBox.appendChild(row);
  });

  // フォーカス流し
  const firstKey = $('.key[data-k="0"]');
  if(firstKey) firstKey.blur(); // モバイルで不要フォーカスを避ける
}

function flash(okNG){
  card.classList.remove('flash-ok','flash-ng');
  void card.offsetWidth; // reflow してアニメをリスタート
  card.classList.add(okNG ? 'flash-ok':'flash-ng');
}

function answer(k){
  if (locked) return;
  locked = true;

  const it = qs[qi];
  const correct = Number(it.answer_index) === Number(k);

  if (correct){
    ok++;
    domOk.textContent = String(ok);
    flash(true);
  }else{
    ng++;
    domNg.textContent = String(ng);
    flash(false);
  }

  // 超短い待ちで次へ（前へ/次へボタンは不要）
  setTimeout(()=>{
    qi++;
    if (qi >= qs.length){ finish(); }
    else { render(); }
    locked = false;
  }, 220);
}

function finish(){
  hide(bar);
  hide(card);

  $('#scoreOk').textContent = String(ok);
  $('#scoreNg').textContent = String(ng);
  $('#scoreTotal').textContent = String(qs.length);

  show(result);
  stopTimer();
}

function resetAll(){
  stopTimer();
  show(setup);
  hide(bar);
  hide(card);
  hide(result);
}

/* ==== イベント ==== */
$('#start').addEventListener('click', startQuiz);
$('#retry').addEventListener('click', resetAll);

// 物理キーボードの誤操作防止（ダブルタップ拡大の副作用軽減）
document.addEventListener('dblclick', e=> e.preventDefault(), {passive:false});

</script>
</body>
</html>
