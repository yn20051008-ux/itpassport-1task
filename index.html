<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>ITパス反復練習</title>
<meta name="theme-color" content="#0b0f14" />
<style>
  :root{
    --bg:#0b0f14;
    --panel:#121823;
    --ink:#e8f0ff;
    --muted:#9bb0ca;
    --green:#12d18e;
    --red:#ff5577;
    --accent:#3b82f6;
    --chip:#0f1623;
    --btn:#1b2333;
    --btnHover:#223049;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Hiragino Sans",Meiryo,"Noto Sans JP",sans-serif;
    -webkit-tap-highlight-color:transparent;
    touch-action:manipulation;
  }
  .wrap{max-width:980px;margin:0 auto;padding:20px 16px 40px}
  header{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin:6px 0 18px}
  header .title{font-weight:800;letter-spacing:.02em;font-size:20px}
  .chips{margin-left:auto;display:flex;gap:10px}
  .chip{display:inline-flex;align-items:center;gap:8px;background:var(--chip);padding:6px 10px;border-radius:999px;font-weight:700}
  .chip .dot{width:10px;height:10px;border-radius:50%}
  .ok .dot{background:var(--green)}
  .ng .dot{background:var(--red)}
  .time{background:transparent;border:1px solid #2a3953}

  .panel{background:var(--panel);border:1px solid #1b2538;border-radius:14px;padding:16px 14px;margin:14px 0}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .label{color:var(--muted)}
  select.btn,button.btn{
    background:var(--btn);color:var(--ink);border:1px solid #2a3953;border-radius:10px;
    height:40px;padding:0 12px;font-weight:700;cursor:pointer;
  }
  select.btn{appearance:none;padding-right:28px;background-image:linear-gradient(45deg,transparent 50%,#7ea3d2 50%),linear-gradient(135deg,#7ea3d2 50%,transparent 50%);background-position:calc(100% - 18px) 17px,calc(100% - 10px) 17px;background-size:8px 8px,8px 8px;background-repeat:no-repeat}
  button.btn:hover{background:var(--btnHover)}
  .hidden{display:none!important}

  /* 問題カード */
  .qcard{background:var(--panel);border:1px solid #1b2538;border-radius:18px;padding:18px}
  .qhead{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;color:var(--muted);font-weight:700}
  .qtext{white-space:pre-wrap;font-size:18px;letter-spacing:.01em}
  .choicesText{margin:14px 0 8px;padding-left:18px}
  .choicesText li{margin:6px 0}
  /* 4ボタン（あ い う え） */
  .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-top:12px}
  .optBtn{
    height:56px;border-radius:12px;border:1px solid #2a3953;background:#0f1623;color:var(--ink);
    font-size:20px;font-weight:800;letter-spacing:.08em;cursor:pointer;outline:none;
    transition:transform .06s ease, background .2s ease;
  }
  .optBtn:active{transform:scale(.98)}
  .optBtn.ok{background:rgba(18,209,142,.18);border-color:rgba(18,209,142,.5)}
  .optBtn.ng{background:rgba(255,85,119,.16);border-color:rgba(255,85,119,.5)}

  /* 終了画面 */
  .center{display:flex;flex-direction:column;align-items:center;gap:14px;padding:24px}

  /* 走ってる間は設定UIを隠す */
  body.is-running .setup{display:none!important}

  /* iPhone notch 余白微調整 */
  .safe{padding-bottom:env(safe-area-inset-bottom)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">ITパス反復練習</div>
      <div class="chips">
        <div class="chip ok"><span class="dot"></span><span>正解 <b id="okCnt">0</b></span></div>
        <div class="chip ng"><span class="dot"></span><span>不正解 <b id="ngCnt">0</b></span></div>
        <div class="chip time"><span>残り <b id="remainTime">--:--</b></span></div>
      </div>
    </header>

    <!-- 設定UI -->
    <section class="panel setup">
      <div class="row">
        <div class="label">出題数：</div>
        <select id="qCount" class="btn">
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="30">30</option>
          <option value="50">50</option>
          <option value="100" selected>100</option>
        </select>
        <div class="label">(順番は 1→100。元データの順で出題)</div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="label">制限時間：</div>
        <select id="limitMin" class="btn">
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="30">30</option>
          <option value="45">45</option>
          <option value="60">60</option>
          <option value="90">90</option>
          <option value="120" selected>120</option>
        </select>
        <div class="label">分</div>
        <button id="startBtn" class="btn" style="margin-left:10px;">開始する</button>
      </div>
      <div class="row" style="margin-top:8px;color:var(--muted);font-size:13px">
        ショートカット：<b>1–4</b>（選択） / <b>Enter</b>（次へ。自動遷移も有）
      </div>
    </section>

    <!-- 問題表示 -->
    <section id="stage" class="qcard hidden safe" aria-live="polite">
      <div class="qhead">
        <div id="qIndex">Q - / -</div>
        <div id="originNo" class="label"></div>
      </div>
      <div id="qText" class="qtext">問題文</div>
      <ol id="choicesText" class="choicesText"></ol>

      <div class="grid4" style="margin-top:8px">
        <button class="optBtn" data-idx="0" aria-label="選択肢1">あ</button>
        <button class="optBtn" data-idx="1" aria-label="選択肢2">い</button>
        <button class="optBtn" data-idx="2" aria-label="選択肢3">う</button>
        <button class="optBtn" data-idx="3" aria-label="選択肢4">え</button>
      </div>
    </section>

    <!-- 終了表示 -->
    <section id="result" class="panel center hidden safe">
      <h2 style="margin:0">おつかれさま！</h2>
      <div id="summary" class="label"></div>
      <div class="row">
        <button id="retryBtn" class="btn">同じ条件でリトライ</button>
        <button id="backBtn" class="btn">設定に戻る</button>
      </div>
    </section>

    <!-- ▼▼▼ ここに “元データ：配列だけ” を貼ります ▼▼▼
         - 先頭~末尾まで **純粋なJSON配列** にしてください（コメント不可）
         - 例：
           [
             {"number":1,"question":"…","choices":["a","b","c","d"],"answer_index":2,"comment":"…"},
             {"number":2,"question":"…","choices":["a","b","c","d"],"answer_index":0,"comment":"…"}
           ]
      -->
    <script id="raw-data" type="application/json">[]</script>
    <!-- ▲▲▲ raw-data 終わり ▲▲▲ -->

    <script>
    (function(){
      "use strict";

      /** 防：ダブルタップ拡大 */
      document.addEventListener('dblclick', (e)=> e.preventDefault(), {passive:false});

      /** DOM */
      const el = {
        ok: document.getElementById('okCnt'),
        ng: document.getElementById('ngCnt'),
        time: document.getElementById('remainTime'),
        countSel: document.getElementById('qCount'),
        minSel: document.getElementById('limitMin'),
        start: document.getElementById('startBtn'),
        stage: document.getElementById('stage'),
        result: document.getElementById('result'),
        summary: document.getElementById('summary'),
        retry: document.getElementById('retryBtn'),
        back: document.getElementById('backBtn'),
        qIndex: document.getElementById('qIndex'),
        originNo: document.getElementById('originNo'),
        qText: document.getElementById('qText'),
        choicesText: document.getElementById('choicesText'),
        optBtns: Array.from(document.querySelectorAll('.optBtn'))
      };

      /** データ読み込み */
      function loadRaw(){
        const tag = document.getElementById('raw-data');
        let data = [];
        try{
          data = JSON.parse(tag.textContent.trim() || "[]");
        }catch(e){
          alert("問題データ(JSON)の構文エラーです。<script id=\"raw-data\"> 内を確認してください。");
          return [];
        }
        if(!Array.isArray(data) || data.length===0){
          alert("問題データがありません。<script id=\"raw-data\"> に配列を貼ってください。");
          return [];
        }
        // 1→100に並び替え（numberがあれば）
        data.sort((a,b)=>{
          const na = Number(a.number)||0, nb = Number(b.number)||0;
          return na-nb;
        });
        // 軽い検証 + 正規化
        return data.map((q,i)=>({
          number: Number(q.number) || (i+1),
          question: String(q.question||""),
          choices: Array.isArray(q.choices)? q.choices.slice(0,4).map(String):["","","",""],
          answer_index: Number(q.answer_index)||0,
          comment: String(q.comment||"")
        }));
      }

      /** 状態 */
      let ALL=[], QUIZ=[], cur=0, ok=0, ng=0, timer=null, remainSec=0, autoNextMs=420;

      function formatTime(sec){
        const m = Math.floor(sec/60), s = sec%60;
        return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      }

      function startGame(){
        ALL = loadRaw();
        if(ALL.length===0) return;

        const n = Math.min(parseInt(el.countSel.value,10)||100, ALL.length);
        QUIZ = ALL.slice(0, n); // 1→N そのまま出題
        cur=0; ok=0; ng=0;
        el.ok.textContent = 0; el.ng.textContent = 0;

        // タイマー
        remainSec = (parseInt(el.minSel.value,10)||120)*60;
        el.time.textContent = formatTime(remainSec);
        if(timer) clearInterval(timer);
        timer = setInterval(()=>{
          remainSec--;
          if(remainSec<=0){
            el.time.textContent = "00:00";
            clearInterval(timer);
            finish();
          }else{
            el.time.textContent = formatTime(remainSec);
          }
        },1000);

        document.body.classList.add('is-running');
        el.result.classList.add('hidden');
        el.stage.classList.remove('hidden');

        render();
        // フォーカスを最初のボタンへ
        setTimeout(()=>el.optBtns[0].focus(), 10);
      }

      function render(){
        const q = QUIZ[cur];
        el.qIndex.textContent = `Q ${cur+1} / ${QUIZ.length}`;
        el.originNo.textContent = q.number ? `(元番号: ${q.number})` : "";
        el.qText.textContent = q.question;

        // 選択肢テキスト（1~4 を表示）。※スペース節約のためテキストを上に集約
        el.choicesText.innerHTML = "";
        q.choices.forEach((t,i)=>{
          const li = document.createElement('li');
          li.textContent = `${i+1}. ${t}`;
          el.choicesText.appendChild(li);
        });

        // ボタン状態リセット
        el.optBtns.forEach(b=>{ b.classList.remove('ok','ng'); b.disabled=false; });
      }

      function decide(choiceIdx){
        const q = QUIZ[cur];
        const correct = (choiceIdx === q.answer_index);
        if(correct){ ok++; el.ok.textContent = ok; }
        else{ ng++; el.ng.textContent = ng; }
        // 瞬間フィードバック（色）
        el.optBtns.forEach((b)=>{
          const idx = parseInt(b.dataset.idx,10);
          b.classList.add(idx===q.answer_index ? 'ok' : (idx===choiceIdx ? 'ng': ''));
          b.disabled=true;
        });

        // 自動で次へ
        setTimeout(next, autoNextMs);
      }

      function next(){
        cur++;
        if(cur>=QUIZ.length){ finish(); return; }
        render();
      }

      function finish(){
        if(timer) clearInterval(timer);
        el.stage.classList.add('hidden');
        el.result.classList.remove('hidden');
        el.summary.textContent = `正解 ${ok} / ${QUIZ.length}　正答率 ${Math.round(ok*100/QUIZ.length)}%`;
        document.body.classList.remove('is-running');
      }

      /** events */
      el.start.addEventListener('click', startGame);
      el.retry.addEventListener('click', startGame);
      el.back.addEventListener('click', ()=>{
        if(timer) clearInterval(timer);
        el.result.classList.add('hidden');
        el.stage.classList.add('hidden');
        document.body.classList.remove('is-running');
      });
      el.optBtns.forEach(b=>{
        b.addEventListener('click', ()=> decide(parseInt(b.dataset.idx,10)));
      });

      // キーボード: 1-4 / Enter
      window.addEventListener('keydown', (e)=>{
        const running = !el.stage.classList.contains('hidden');
        if(!running) return;
        if(e.key>='1' && e.key<='4'){
          e.preventDefault();
          decide(parseInt(e.key,10)-1);
        }else if(e.key==='Enter'){
          e.preventDefault();
          next();
        }
      });

    })();
    </script>
  </div>
</body>
</html>