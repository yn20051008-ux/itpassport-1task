<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>ITパスポート 過去問トレーナー（2025r07）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --bg:#0f1115; --panel:#151924; --accent:#4cc9f0; --ok:#4caf50; --ng:#ef5350; --muted:#99a2b2; --text:#e6eaf2;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0f1115,#0d1220);color:var(--text);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{color:var(--accent)}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    .card{background:var(--panel);border:1px solid #1f2533;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .pad{padding:20px}
    h1{font-size:22px;margin:0 0 12px}
    h2{font-size:18px;margin:0 0 10px}
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .col{flex:1 1 240px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:12px 16px;border:1px solid #283044;border-radius:12px;background:#1a2130;color:var(--text);cursor:pointer;font-weight:600}
    .btn:hover{border-color:#34405a}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn-primary{background:linear-gradient(180deg,#1c2a46,#15233c);border-color:#2d3a55}
    .btn-accent{background:linear-gradient(180deg,#13364a,#0f2e42);border-color:#1f546c;color:#bfeaff}
    .btn-ghost{background:transparent}
    .answers{display:grid;gap:12px}
    @media(min-width:640px){.answers{grid-template-columns:1fr 1fr}}
    .opt{
      padding:14px;border:1px solid #2a3347;border-radius:12px;background:#172033;cursor:pointer;text-align:left;
    }
    .opt:hover{border-color:#3a4664}
    .opt.correct{border-color:var(--ok);background:rgba(76,175,80,.08)}
    .opt.wrong{border-color:var(--ng);background:rgba(239,83,80,.08)}
    .opt.disabled{opacity:.7;pointer-events:none}
    .opt, .opt * { color: var(--text) !important; } /* 文字色を強制的に白系に固定 */
    .kana{display:inline-block;min-width:2ch;text-align:center;margin-right:.5rem;color:#b8c2d8}
    .muted{color:var(--muted)}
    .bar{height:10px;background:#222a3a;border-radius:999px;overflow:hidden}
    .bar>i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#8bd7ff);width:0%}
    .footer{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:16px}
    .chip{display:inline-flex;gap:.4rem;align-items:center;padding:6px 10px;border:1px solid #2a3246;border-radius:999px;background:#121829}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;border:1px solid #3a4563;border-radius:6px;padding:1px 6px;background:#0f1423;color:#c7d2ee}
    .list{margin:0;padding-left:18px}
    .s{opacity:.85}
    .tag{display:inline-block;padding:2px 8px;border:1px solid #32405a;border-radius:999px;margin-left:.5rem;font-size:12px;color:#b7c5df}
    .warn{color:#ffb4b4}
    .ok{color:#b7ffb7}
    .split{display:flex;gap:14px;flex-wrap:wrap}
    .split>.grow{flex:1 1 520px}
    .split>.side{flex:1 1 260px}
    .hide{display:none}
    .small{font-size:13px}
    .hr{height:1px;background:#262d40;margin:12px 0}
    .right{display:flex;gap:8px;align-items:center;justify-content:flex-end}
  </style>
</head>
<body>
<div class="wrap">
  <!-- スタート画面 -->
  <div class="card pad" id="screen-start">
    <h1>ITパスポート 過去問トレーナー <span class="tag">2025r07 OCR</span></h1>
    <p class="muted s">データ：<code>data/itpassport_2025r07.json</code>（OCR抽出。欠損は順次補完）</p>
    <div class="row">
      <div class="col">
        <h2>出題モード</h2>
        <label><input type="radio" name="mode" value="train" checked> 学習（その場採点）</label><br>
        <label><input type="radio" name="mode" value="exam"> 模試（最後に採点）</label>
      </div>
      <div class="col">
        <h2>出題数</h2>
        <select id="countSel">
          <option value="10">10問</option>
          <option value="20">20問</option>
          <option value="30">30問</option>
          <option value="50">50問</option>
          <option value="all" selected>全件</option>
        </select>
      </div>
      <div class="col">
        <h2>出題順</h2>
        <label><input type="radio" name="order" value="random" checked> ランダム</label><br>
        <label><input type="radio" name="order" value="asc"> 昇順</label>
      </div>
      <div class="col">
        <h2>オプション</h2>
        <label><input type="checkbox" id="autoNext" checked> 正解で自動次へ</label><br>
        <label><input type="checkbox" id="includeStubs" checked> 解答のみの問題も含める</label><br>
        <label class="small muted">ショートカット：<span class="kbd">1–4</span> 解答 / <span class="kbd">N</span> 次 / <span class="kbd">B</span> 戻</label>
      </div>
    </div>
    <div class="hr"></div>
    <div class="row">
      <div class="col"><button class="btn btn-primary" id="btnStart">開始する</button></div>
      <div class="col"><button class="btn btn-ghost" id="btnReload">データ再読込</button></div>
    </div>
    <div class="hr"></div>
    <div class="small muted" id="datasetInfo">読み込み中…</div>
  </div>

  <!-- 出題画面 -->
  <div class="card pad hide" id="screen-quiz">
    <div class="split">
      <div class="grow">
        <div class="footer">
          <div><strong id="titleNum">問-</strong> / <span id="totalNum">-</span>　<span class="tag" id="modeTag">TRAIN</span></div>
          <div class="right">
            <label class="small"><input type="checkbox" id="toggleNav"> ナビを隠す</label>
            <div class="chip"><span id="timer">--:--</span></div>
          </div>
        </div>
        <div class="bar" style="margin:10px 0 16px"><i id="bar"></i></div>
        <div id="qText" style="font-size:18px;margin:8px 0 12px;white-space:pre-wrap"></div>
        <div class="answers" id="answers"></div>
        <div id="explain" class="small muted" style="margin-top:10px"></div>
        <div class="footer">
          <div class="row" style="gap:8px">
            <button class="btn" id="prevBtn" title="B">← 戻る</button>
            <button class="btn btn-accent" id="revealBtn">解答を表示</button>
            <button class="btn" id="skipBtn">スキップ</button>
            <button class="btn btn-primary" id="nextBtn" title="N">次へ →</button>
          </div>
          <div class="muted small">正解：<span class="ok" id="statOk">0</span>　不正解：<span class="warn" id="statNg">0</span></div>
        </div>
      </div>
      <div class="side" id="navWrap">
        <h2 style="margin-top:0">ナビ</h2>
        <div id="nav" class="small" style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px"></div>
        <div class="hr"></div>
        <button class="btn btn-ghost" id="btnFinish">採点する（模試）/ 終了</button>
        <div class="small muted" style="margin-top:8px">
          番号は出題順。未回答は灰、正解は緑、不正解は赤。
        </div>
      </div>
    </div>
  </div>

  <!-- 結果画面 -->
  <div class="card pad hide" id="screen-result">
    <h1>結果</h1>
    <p><strong id="scoreText">-</strong>　<span class="muted">所要：<span id="elapsedText">-</span></span></p>
    <div class="row" style="margin:10px 0 16px">
      <button class="btn btn-primary" id="retryWrong">不正解だけ復習</button>
      <button class="btn" id="retryAll">もう一度はじめる</button>
      <button class="btn" id="exportCsv">CSVを書き出し</button>
      <button class="btn btn-ghost" id="backHome">設定に戻る</button>
    </div>
    <div id="review"></div>
  </div>
</div>

<script>
const DATA_URL = './data/itpassport_2025r07.json';
const KANA = ['ア','イ','ウ','エ'];
const EXAM_LIMIT_SEC = 120 * 60; // 120分

let RAW=[], POOL=[], ORDER=[];
let CUR=0, MODE='train', AUTONEXT=true, INCLUDE_STUBS=true;
let START_TIME=0, TIMER_ID=null, remainingSec=0;

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmtTime = sec => { const s=Math.max(0,Math.floor(sec)); return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; };
const shuffle = a => { for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };

async function loadData(){
  $('#datasetInfo').textContent = '読み込み中…';
  try{
    const r = await fetch(DATA_URL,{cache:'no-store'});
    if(!r.ok) throw new Error(r.status+' '+r.statusText);
    const data = await r.json();
    RAW = (data.questions||[]).map(q=>({...q, selected:null, result:null, seen:false}));
    const full = RAW.filter(q => q.question && q.choices && q.choices.length===4 && Number.isInteger(q.answer_index));
    const stub = RAW.filter(q => !(q.question && q.choices && q.choices.length===4));
    $('#datasetInfo').innerHTML = `問題総数：<strong>${RAW.length}</strong>　完全抽出：<strong>${full.length}</strong>　スタブ：<strong>${stub.length}</strong>`;
  }catch(e){
    $('#datasetInfo').innerHTML = `読み込み失敗：<span class="warn">${e.message}</span><br>パス <code>${DATA_URL}</code> と公開状態をご確認ください。`;
  }
}
loadData();
$('#btnReload').addEventListener('click', loadData);

$('#btnStart').addEventListener('click', () => {
  MODE = $$('input[name="mode"]').find(r=>r.checked)?.value || 'train';
  AUTONEXT = $('#autoNext').checked;
  INCLUDE_STUBS = $('#includeStubs').checked;

  const full = RAW.filter(q => q.question && q.choices && q.choices.length===4 && Number.isInteger(q.answer_index));
  const stubs = RAW.filter(q => !(q.question && q.choices && q.choices.length===4));
  POOL = INCLUDE_STUBS ? [...full, ...stubs] : full;
  if(POOL.length===0){ alert('出題できる問題がありません。JSON配置を確認してください。'); return; }

  const orderSel = $$('input[name="order"]').find(r=>r.checked)?.value || 'random';
  ORDER = [...Array(POOL.length).keys()];
  if(orderSel==='random') shuffle(ORDER);
  const cnt = $('#countSel').value;
  if(cnt!=='all') ORDER = ORDER.slice(0, Math.min(parseInt(cnt,10), ORDER.length));

  POOL.forEach(q=>{ q.selected=null; q.result=null; q.seen=false; });
  CUR=0;

  if(MODE === 'exam'){
    remainingSec = EXAM_LIMIT_SEC;
    $('#timer').textContent = fmtTime(remainingSec);
  }else{
    remainingSec = 0;
    START_TIME=Date.now();
  }
  startTimer();

  $('#screen-start').classList.add('hide');
  $('#screen-result').classList.add('hide');
  $('#screen-quiz').classList.remove('hide');
  $('#modeTag').textContent = MODE.toUpperCase();

  renderQuestion(); renderNav();
});

function startTimer(){
  clearInterval(TIMER_ID);
  TIMER_ID = setInterval(()=>{
    if(MODE === 'exam'){
      remainingSec = Math.max(0, remainingSec - 1);
      $('#timer').textContent = fmtTime(remainingSec);
      if(remainingSec === 0){ clearInterval(TIMER_ID); finish(); }
    }else{
      const sec = (Date.now() - START_TIME) / 1000;
      $('#timer').textContent = fmtTime(sec);
    }
  }, 1000);
}

$('#toggleNav').addEventListener('change', (e)=>{ $('#navWrap').style.display = e.target.checked ? 'none' : ''; });

function renderQuestion(){
  const idx = ORDER[CUR], q = POOL[idx];
  $('#titleNum').textContent = `問${q.number ?? (idx+1)}`;
  $('#totalNum').textContent = ORDER.length;
  $('#bar').style.width = `${((CUR)/Math.max(1,ORDER.length-1))*100}%`;

  const disabled = !!(q.result!==null || MODE==='exam');
  $('#qText').textContent = q.question ? q.question : '（本文未抽出：解答のみ保持のスタブ問題）';

  const answersEl = $('#answers'); answersEl.innerHTML='';
  if(q.choices && q.choices.length===4){
    q.choices.forEach((text,i)=>{
      const btn = document.createElement('button');
      btn.className = 'opt';
      btn.dataset.index = i;
      btn.innerHTML = `<span class="kana">${KANA[i]}</span>${escapeHtml(text)}`;
      if(disabled && q.selected===null) btn.classList.add('disabled');
      if(q.result!==null){
        if(i===q.answer_index) btn.classList.add('correct');
        if(q.selected===i && !q.result) btn.classList.add('wrong');
      }
      btn.addEventListener('click',()=>selectChoice(i));
      answersEl.appendChild(btn);
    });
  }else{
    const stub = document.createElement('div');
    stub.className='muted';
    stub.textContent='選択肢未収録のため、この設問は採点対象外です。';
    answersEl.appendChild(stub);
  }

  $('#explain').textContent = q.explanation ? `解説：${q.explanation}` : '';
  $('#prevBtn').disabled = CUR===0;
  $('#nextBtn').disabled = CUR>=ORDER.length-1;
  $('#revealBtn').disabled = !(MODE==='exam' && q.choices && Number.isInteger(q.answer_index));
  $('#skipBtn').disabled = false;

  const ok = POOL.filter(x=>x.result===true).length;
  const ng = POOL.filter(x=>x.result===false).length;
  $('#statOk').textContent = ok; $('#statNg').textContent = ng;
  q.seen=true;
}

function selectChoice(i){
  const idx = ORDER[CUR], q = POOL[idx];
  if(!q.choices || !Number.isInteger(q.answer_index)) return;
  if(MODE==='exam'){
    q.selected = i; renderNav();
    if(CUR<ORDER.length-1){ CUR++; renderQuestion(); }
    return;
  }
  q.selected = i; q.result = (i===q.answer_index);
  renderQuestion(); renderNav();
  if(AUTONEXT && q.result && CUR<ORDER.length-1){ setTimeout(()=>{ CUR++; renderQuestion(); }, 150); }
}

$('#prevBtn').addEventListener('click', ()=>{ if(CUR>0){ CUR--; renderQuestion(); }});
$('#nextBtn').addEventListener('click', ()=>{ if(CUR<ORDER.length-1){ CUR++; renderQuestion(); }});
$('#skipBtn').addEventListener('click', ()=>{ if(CUR<ORDER.length-1){ CUR++; renderQuestion(); }});
$('#revealBtn').addEventListener('click', ()=>{
  const idx = ORDER[CUR], q = POOL[idx];
  if(!q.choices || !Number.isInteger(q.answer_index)) return;
  if(q.selected==null){ alert('まずどれか選択してください。'); return; }
  q.result = (q.selected===q.answer_index);
  renderQuestion(); renderNav();
});
$('#btnFinish').addEventListener('click', finish);

function finish(){
  clearInterval(TIMER_ID);
  if(MODE==='exam'){
    for(const q of POOL){
      if(q.choices && Number.isInteger(q.answer_index) && q.selected!=null){
        q.result = (q.selected===q.answer_index);
      }
    }
  }
  $('#screen-quiz').classList.add('hide');
  $('#screen-result').classList.remove('hide');

  const ok = POOL.filter(x=>x.result===true).length;
  const count = POOL.filter(x=>x.choices && Number.isInteger(x.answer_index)).length;
  $('#scoreText').textContent = `正解 ${ok} / ${count}（${Math.round(ok/count*100)||0}%）`;
  $('#elapsedText').textContent = MODE==='exam' ? '120:00 → 0:00' : fmtTime((Date.now()-START_TIME)/1000);

  const wrongs = POOL.filter(x=>x.result===false).map(x=>({num:x.number ?? '-', q:x.question || '（本文なし）', ans:x.answer_index, sel:x.selected}));
  const container = $('#review'); container.innerHTML='';
  if(wrongs.length===0){ container.innerHTML = '<p class="ok">全問正解！</p>'; }
  else{
    const ol = document.createElement('ol'); ol.className='list';
    wrongs.forEach(w=>{
      const li = document.createElement('li');
      const ck = w.ans!=null ? KANA[w.ans] : '-';
      const sk = w.sel!=null ? KANA[w.sel] : '-';
      li.innerHTML = `<strong>問${w.num}</strong>　<small class="muted">正解:${ck} / 回答:${sk}</small><br>${escapeHtml(w.q)}`;
      ol.appendChild(li);
    });
    container.appendChild(ol);
  }
}

$('#retryWrong').addEventListener('click', ()=>{
  const wrongIdx = ORDER.filter(i => { const q=POOL[i]; return q.result===false && q.choices && Number.isInteger(q.answer_index); });
  if(wrongIdx.length===0){ alert('不正解がありません。'); return; }
  ORDER = wrongIdx; ORDER.forEach(i=>{ POOL[i].selected=null; POOL[i].result=null; });
  CUR=0; START_TIME=Date.now(); startTimer();
  $('#screen-result').classList.add('hide'); $('#screen-quiz').classList.remove('hide');
  renderQuestion(); renderNav();
});

$('#retryAll').addEventListener('click', ()=>{ $('#screen-result').classList.add('hide'); $('#screen-start').classList.remove('hide'); });
$('#exportCsv').addEventListener('click', ()=>{
  const rows = [['number','selectedKana','correctKana','result']];
  ORDER.forEach(i=>{
    const q=POOL[i];
    const sel = q.selected!=null ? KANA[q.selected] : '';
    const cor = Number.isInteger(q.answer_index) ? KANA[q.answer_index] : '';
    const res = q.result==null ? '' : (q.result?'OK':'NG');
    rows.push([q.number, sel, cor, res]);
  });
  const csv = rows.map(r=>r.map(s=>`"${String(s??'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='itpassport_result.csv'; a.click(); URL.revokeObjectURL(a.href);
});
$('#backHome').addEventListener('click', ()=>{ $('#screen-result').classList.add('hide'); $('#screen-start').classList.remove('hide'); });

function renderNav(){
  const nav=$('#nav'); nav.innerHTML='';
  ORDER.forEach((i,idx)=>{
    const q=POOL[i]; const b=document.createElement('button');
    b.className='btn small'; b.style.padding='6px'; b.textContent = (idx + 1); // 出題順を表示
    if(q.result===true){ b.style.borderColor='#2e7d32'; b.style.background='rgba(46,125,50,.15)'; }
    else if(q.result===false){ b.style.borderColor='#b23a3a'; b.style.background='rgba(178,58,58,.12)'; }
    else if(q.selected!=null){ b.style.borderColor='#3a4a6b'; } else { b.style.opacity='.75'; }
    if(idx===CUR){ b.style.outline='2px solid var(--accent)'; }
    b.addEventListener('click',()=>{ CUR=idx; renderQuestion(); });
    nav.appendChild(b);
  });
}

window.addEventListener('keydown', (e)=>{
  if($('#screen-quiz').classList.contains('hide')) return;
  if(e.key>='1' && e.key<='4'){
    const i = parseInt(e.key,10)-1;
    const idx = ORDER[CUR]; const q = POOL[idx];
    if(q.choices && Number.isInteger(q.answer_index)) selectChoice(i);
  }else if(e.key==='n' || e.key==='N'){
    if(CUR<ORDER.length-1){ CUR++; renderQuestion(); }
  }else if(e.key==='b' || e.key==='B'){
    if(CUR>0){ CUR--; renderQuestion(); }
  }
});

function escapeHtml(s){ return String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
</script>
</body>
</html>
