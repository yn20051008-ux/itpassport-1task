<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ITパス 練習｜シンプルクール × 反復最速</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#121823;
      --panel-2:#0f1520;
      --text:#e8eef7;
      --muted:#9fb0c5;
      --ok:#1fbf74;
      --ng:#e35b5b;
      --ring:#273244;
      --accent:#3b82f6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      background: radial-gradient(1200px 800px at 50% -200px, #172033 0%, #0b0f14 70%) no-repeat, var(--bg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", "Yu Gothic UI", "YuGothic", "Helvetica Neue", Arial, sans-serif;
      letter-spacing:.2px;
    }

    .wrap{
      min-height:100dvh;
      display:flex;
      flex-direction:column;
      gap:14px;
      padding:16px clamp(12px, 3vw, 24px) max(12px, env(safe-area-inset-bottom));
    }

    /* ヘッダ（タイトル + HUD） */
    header{display:flex; align-items:center; justify-content:space-between; gap:12px}
    h1{
      margin:0; font-size: clamp(16px, 4.5vw, 20px);
      font-weight:800; letter-spacing:.4px;
    }
    #hud{
      display:flex; gap:8px; align-items:center;
    }
    .pill{
      padding:4px 10px; border-radius:999px; background:var(--panel);
      border:1px solid var(--ring); font-size:12px; line-height:1; white-space:nowrap;
    }
    .pill.ok{ color:#c2ffe3; background:rgba(31,191,116,.12); border-color:rgba(31,191,116,.25); }
    .pill.ng{ color:#ffe1e1; background:rgba(227,91,91,.12); border-color:rgba(227,91,91,.25); }
    .pill.time{ color:#e1ecff; background:rgba(59,130,246,.12); border-color:rgba(59,130,246,.25); }

    /* セットアップ行（出題数 / 制限時間 / 開始） */
    .toolbar{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      padding:10px; background:var(--panel-2); border:1px solid var(--ring); border-radius:12px;
    }
    .row{display:flex; gap:8px; align-items:center;}
    .label{font-size:14px; color:var(--muted)}
    select, input[type="number"], button.btn{
      background:var(--panel); color:var(--text); border:1px solid var(--ring);
      border-radius:8px; padding:8px 10px; font-size:14px;
    }
    button.btn.primary{ background:var(--accent); border-color:transparent; color:#fff; font-weight:700; }

    /* 本体 */
    .stage{
      flex:1 1 auto; display:flex; flex-direction:column; gap:12px;
      overflow:hidden; /* スクロール無しの原則 */
    }

    /* 問題カード */
    #card{
      flex:1 1 auto; background:var(--panel); border:1px solid var(--ring); border-radius:14px;
      padding:14px; display:flex; flex-direction:column; gap:8px; overflow:hidden;
      transform-origin: top left;
    }
    #meta{font-size:12px; color:var(--muted); display:flex; gap:10px}
    #question{ font-size: clamp(14px, 2.6vw, 18px); line-height:1.35; }

    /* 選択文（問題カード内に出す） */
    ol#choices{
      margin:6px 0 0; padding-left: 1.2em;
      display:block; gap:0;
    }
    #choices li{
      margin:2px 0; font-size: clamp(13px, 2.3vw, 17px); line-height:1.3;
    }

    /* 1行4列キーパッド（あ・い・う・え） */
    .keypad{
      margin-top:6px;
      display:grid; grid-template-columns:repeat(4,1fr); gap:8px;
    }
    .keypad button{
      min-height:44px; border-radius:10px; font-weight:800; font-size:16px;
      background:#1b2432; color:#fff; border:1px solid var(--ring);
      transition: transform .03s ease;
    }
    .keypad button:active{ transform: translateY(1px); }
    .keypad button.ok{ background:rgba(31,191,116,.14); border-color:rgba(31,191,116,.4); color:#d7ffe9; }
    .keypad button.ng{ background:rgba(227,91,91,.14); border-color:rgba(227,91,91,.45); color:#ffe5e5; }

    /* 終了モーダル */
    dialog::backdrop{ background: rgba(0,0,0,.6); }
    dialog{
      border:1px solid var(--ring); border-radius:14px; padding:18px; background:var(--panel); color:var(--text);
      max-width:min(520px, 92vw);
    }
    dialog h2{ margin:0 0 6px; font-size:18px }
    dialog .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px }
    .muted{ color:var(--muted); font-size:13px }

    /* 小画面の余白最適化 */
    @media (max-width:430px){
      .toolbar{ gap:8px; padding:8px }
      .label{ font-size:13px }
      select, input[type="number"], button.btn{ font-size:13px; padding:7px 8px }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ITパス 練習｜シンプルクール × 反復最速</h1>
      <div id="hud">
        <div class="pill ok">正解 <span id="okCnt">0</span></div>
        <div class="pill ng">不正解 <span id="ngCnt">0</span></div>
        <div class="pill time">残り <span id="timeLeft">00:00</span></div>
      </div>
    </header>

    <!-- セットアップ（出題数・制限時間・開始） -->
    <div class="toolbar" id="setupBar">
      <div class="row">
        <div class="label">出題数：</div>
        <input id="qCount" type="number" min="1" max="200" step="1" value="20" class="btn" />
        <div class="label">(順番は 1→100。元データの順で出題)</div>
      </div>
      <div class="row">
        <div class="label">制限時間：</div>
        <select id="limitMin" class="btn">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="30">30</option>
          <option value="45">45</option>
          <option value="60">60</option>
          <option value="90">90</option>
          <option value="120">120</option>
        </select>
        <div class="label">分</div>
      </div>
      <div class="row">
        <button id="startBtn" class="btn primary">開始する</button>
      </div>
    </div>

    <!-- 本体 -->
    <main class="stage" id="stage" hidden>
      <div id="card">
        <div id="meta"><span id="qno"></span><span id="orig"></span></div>
        <div id="question"></div>
        <ol id="choices"></ol>

        <div class="keypad" id="pad">
          <button data-idx="0" aria-label="あ">あ</button>
          <button data-idx="1" aria-label="い">い</button>
          <button data-idx="2" aria-label="う">う</button>
          <button data-idx="3" aria-label="え">え</button>
        </div>
      </div>
    </main>

    <!-- データ貼付け領域（★ここに配列だけを入れる） -->
    <script id="raw-data" type="application/json">
      <!-- ★ここに“元データ”配列だけを貼る -->
      <!-- 例：
      [
        {"number":1,"question":"ダミー","choices":["A","B","C","D"],"answer_index":2}
      ]
      -->
    </script>

    <!-- 結果モーダル -->
    <dialog id="resultDlg">
      <h2>セッション終了</h2>
      <div>正解 <b id="finOk">0</b> / 不正解 <b id="finNg">0</b></div>
      <div class="muted" id="finMeta"></div>
      <div class="actions">
        <button id="againBtn" class="btn">同じ条件で再開</button>
        <button id="resetBtn" class="btn primary">最初の画面に戻る</button>
      </div>
    </dialog>

  </div>

  <script>
  (function(){
    "use strict";

    // ---------- DOM 取得 ----------
    const $ = sel => document.querySelector(sel);
    const hudOk = $('#okCnt'), hudNg = $('#ngCnt'), hudTime = $('#timeLeft');
    const setupBar = $('#setupBar'), stage = $('#stage'), pad = $('#pad');
    const qno = $('#qno'), orig = $('#orig'), qtext = $('#question'), ol = $('#choices');
    const dlg = $('#resultDlg'), finOk = $('#finOk'), finNg = $('#finNg'), finMeta = $('#finMeta');

    // ---------- 状態 ----------
    const state = {
      all: [],              // 全問題
      use: [],              // 今回使う問題配列
      i: 0,                 // 今のインデックス
      ok: 0, ng: 0,
      tRemain: 0,           // 残り秒
      tHandle: null,
      cfg: { count: 20, limitMin: 20 }
    };

    // ---------- データ取得 ----------
    function loadData(){
      const tag = document.getElementById('raw-data');
      const raw = tag.textContent.trim();
      if(!raw){
        alert('問題データがありません。<script id="raw-data"> に配列を貼ってください。');
        throw new Error('no data');
      }
      try{
        const arr = JSON.parse(raw);
        if(!Array.isArray(arr)) throw 0;
        // 軽いバリデーション
        arr.forEach((q,idx)=>{
          if(!q || typeof q !== 'object') throw new Error(`Q${idx+1}: オブジェクトではありません`);
          if(!Array.isArray(q.choices) || q.choices.length !== 4) throw new Error(`Q${q.number||idx+1}: choices は4件が必要です`);
          if(typeof q.answer_index !== 'number') throw new Error(`Q${q.number||idx+1}: answer_index がありません`);
        });
        state.all = arr;
      }catch(e){
        console.error(e);
        alert('問題データ(JSON)の構文に誤りがあります。\n・先頭/末尾のカンマ禁止\n・コメント不可\n・配列 [ {...}, {...} ] だけを貼ってください。');
        throw e;
      }
    }

    // ---------- 画面セットアップ ----------
    function init(){
      // 既定値
      $('#qCount').value = state.cfg.count;
      $('#limitMin').value = state.cfg.limitMin;

      $('#startBtn').addEventListener('click', start);

      // キーパッド
      pad.addEventListener('click', (e)=>{
        const btn = e.target.closest('button');
        if(!btn) return;
        answer(parseInt(btn.dataset.idx,10));
      });

      // キーショートカット（表示は出さない）
      window.addEventListener('keydown', (e)=>{
        const m = {'1':0,'2':1,'3':2,'4':3}[e.key];
        if(m!=null){ e.preventDefault(); answer(m); }
        else if(e.key === 'Enter'){ e.preventDefault(); next(); }
      });

      // モーダルボタン
      $('#againBtn').addEventListener('click', ()=>{ dlg.close(); restartSame(); });
      $('#resetBtn').addEventListener('click', ()=>{ dlg.close(); hardReset(); });
    }

    // ---------- 開始 / 再開 ----------
    function start(){
      try{ if(state.all.length===0) loadData(); }catch{ return; }

      const cnt = clamp(parseInt($('#qCount').value,10)||1, 1, state.all.length);
      const lm  = parseInt($('#limitMin').value,10)||20;

      state.cfg.count = cnt; state.cfg.limitMin = lm;

      // 使用する問題（順番は元データのまま）
      state.use = state.all.slice(0, cnt);
      state.i = 0; state.ok = 0; state.ng = 0;
      hudOk.textContent = '0'; hudNg.textContent = '0';

      // タイマー
      if(state.tHandle) clearInterval(state.tHandle);
      state.tRemain = lm*60;
      tick(); // 1回即時更新
      state.tHandle = setInterval(()=>{
        state.tRemain--;
        tick();
        if(state.tRemain<=0){ finish('時間切れ'); }
      }, 1000);

      setupBar.hidden = true;
      stage.hidden = false;

      render();
    }

    function restartSame(){
      // 同じ設定・同じ先頭から
      state.i = 0; state.ok = 0; state.ng = 0;
      hudOk.textContent = '0'; hudNg.textContent = '0';

      if(state.tHandle) clearInterval(state.tHandle);
      state.tRemain = state.cfg.limitMin*60;
      tick();
      state.tHandle = setInterval(()=>{
        state.tRemain--;
        tick();
        if(state.tRemain<=0){ finish('時間切れ'); }
      }, 1000);

      setupBar.hidden = true;
      stage.hidden = false;

      render();
    }

    function hardReset(){
      if(state.tHandle) clearInterval(state.tHandle);
      setupBar.hidden = false;
      stage.hidden = true;
    }

    // ---------- 表示 ----------
    function render(){
      const q = state.use[state.i];
      if(!q){ finish(); return; }

      qno.textContent  = `Q ${state.i+1} / ${state.use.length}`;
      orig.textContent = `(元番号: ${q.number ?? '—'})`;
      qtext.textContent = q.question;

      // 選択文（カード内）
      ol.innerHTML = '';
      q.choices.forEach((t)=> {
        const li = document.createElement('li');
        li.textContent = t;
        ol.appendChild(li);
      });

      // キーパッドの色リセット
      pad.querySelectorAll('button').forEach(b=>{ b.classList.remove('ok','ng'); b.disabled=false; });

      // はみ出し時の自動縮小（スクロール禁止のため）
      fitCard();
    }

    // はみ出していたら少し縮小してカード内に収める
    function fitCard(){
      const card = document.getElementById('card');
      card.style.transform = 'scale(1)';
      let scale = 1, min = 0.84, step = 0.02;
      const tooTall = ()=> card.scrollHeight > card.clientHeight;
      let guard=0;
      while(tooTall() && scale>min && guard<20){
        scale -= step; guard++;
        card.style.transform = `scale(${scale})`;
      }
    }

    // ---------- 回答処理 ----------
    function answer(idx){
      const q = state.use[state.i]; if(!q) return;
      const ok = (idx === q.answer_index);
      const b = pad.querySelector(`button[data-idx="${idx}"]`);
      b.classList.add(ok ? 'ok':'ng');

      pad.querySelectorAll('button').forEach(x=>x.disabled=true);

      if(ok){ state.ok++; hudOk.textContent = state.ok; }
      else  { state.ng++; hudNg.textContent = state.ng; }

      setTimeout(next, 220);
    }

    function next(){
      state.i++;
      if(state.i >= state.use.length){ finish(); }
      else { render(); }
    }

    // ---------- タイマー表示 ----------
    function tick(){
      hudTime.textContent = toMinSec(state.tRemain);
    }
    function toMinSec(sec){
      const m = Math.floor(sec/60).toString().padStart(2,'0');
      const s = Math.floor(sec%60).toString().padStart(2,'0');
      return `${m}:${s}`;
    }

    // ---------- 終了 ----------
    function finish(reason=''){
      if(state.tHandle) { clearInterval(state.tHandle); state.tHandle=null; }
      finOk.textContent = state.ok;
      finNg.textContent = state.ng;
      const done = `${state.use.length}問 / 経過 ${toMinSec(state.cfg.limitMin*60 - state.tRemain)}` + (reason?`（${reason}）`:'');
      finMeta.textContent = done;
      dlg.showModal();
    }

    // ---------- ユーティリティ ----------
    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

    // ---------- 起動 ----------
    init();
  })();
  </script>
</body>
</html>