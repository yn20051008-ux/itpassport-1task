<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ITパスポート問題集</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<style>
:root{ --bg:#0b0d14; --panel:#121623; --accent:#52b2ff; --text:#eef3ff; --muted:#91a0bd; --ok:#4caf50; --ng:#ef5350; --line:#20273a; }
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:linear-gradient(180deg,#0b0d14,#0a1020);
  color:var(--text);font:16px/1.7 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  overscroll-behavior:none; touch-action:manipulation; overflow-x:hidden;
}
.app{max-width:960px;margin:0 auto;padding:18px 18px calc(18px + env(safe-area-inset-bottom));min-height:100svh;display:block;}
.card{background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,.28)}
.pad{padding:16px}
@media(max-width:420px){ .pad{padding:12px} }
h1,h2,p{margin:0}
.muted{color:var(--muted)} .small{font-size:12px} .hide{display:none}
.btn{padding:12px 20px;border:1px solid var(--accent);background:var(--accent);color:white;border-radius:8px;cursor:pointer;margin:4px}
.btn.ghost{background:transparent;color:var(--accent)}
.btn.primary{background:var(--accent);border-color:var(--accent)}

/* HUD */
.top{display:flex;align-items:center;gap:12px;justify-content:space-between}
.top .left{display:flex;align-items:center;gap:10px}
.badge{font-size:12px;padding:2px 8px;border:1px solid var(--line);border-radius:999px;color:#bcd2ff}
.timer{font-variant-numeric:tabular-nums;padding:0;border:0;background:transparent;}
.counters{display:flex;gap:10px}
.counter{font-variant-numeric:tabular-nums}
.counter.ok{color:#b7ffb7}
.counter.ng{color:#ffb4b4}
.bar{height:10px;background:#1a2132;border-radius:999px;overflow:hidden;margin:8px 0 0}
.bar>i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#95d0ff);width:0%}

/* 問題表示（コンパクト） */
.q{font-size:clamp(15px,3.9vw,18px);line-height:1.6;white-space:pre-wrap}
.choice-list{margin-top:10px;display:grid;grid-template-columns:1fr;gap:8px}
.choice-line{display:flex;gap:.6rem;align-items:flex-start}
.choice-line .kana{flex:0 0 2.2ch;text-align:center;color:#b9c6e6}
.choice-line p{margin:0;white-space:pre-wrap}

/* ボタン：1行4列・かなのみ */
.answers{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:14px}
.opt{
  display:flex;align-items:center;justify-content:center;min-height:44px;
  padding:10px;border:1px solid #27314a;background:#151c2c;border-radius:12px;
  cursor:pointer;user-select:none;touch-action:manipulation;box-shadow:0 6px 18px rgba(0,0,0,.22);
  font-size:18px;letter-spacing:.1em;
}
.opt:hover{border-color:#33415f}
.opt.correct{border-color:var(--ok);background:rgba(76,175,80,.12)}
.opt.wrong{border-color:var(--ng);background:rgba(239,83,80,.12)}

/* file upload */
.upload-area{border:2px dashed var(--line);border-radius:12px;padding:20px;text-align:center;margin:20px 0}
.upload-area.dragover{border-color:var(--accent);background:rgba(82,178,255,.1)}

/* floating nav */
.fab{position:fixed;right:16px;bottom:calc(16px + env(safe-area-inset-bottom));width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#16213a;border:1px solid #283655;cursor:pointer;box-shadow:0 10px 24px rgba(0,0,0,.35);z-index:50}
.fab span{font-size:20px;line-height:1}

/* overlay nav */
.overlay{position:fixed;inset:0;background:rgba(6,10,20,.65);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;padding:16px;z-index:40}
.ov-card{width:min(860px,92vw);max-height:80vh;overflow:auto;background:#0f1426;border:1px solid #2b3653;border-radius:14px;padding:14px}
.grid{display:grid;grid-template-columns:repeat(10,1fr);gap:6px}
.navbtn{padding:8px;border:1px solid #2a3553;background:#121a33;color:#cdd7f3;border-radius:10px;cursor:pointer}
.navbtn:hover{border-color:#3c4c75}
.navbtn.cur{outline:2px solid var(--accent)}
.navbtn.ok{border-color:#2e7d32;background:rgba(46,125,50,.15)}
.navbtn.ng{border-color:#b23a3a;background:rgba(178,58,58,.12)}
.xrow{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.close{padding:6px 10px;border:1px solid #2a3553;border-radius:999px;background:#121a33;color:#cdd7f3;cursor:pointer}

/* START */
.center{display:grid;place-items:center;min-height:70vh}
.hero{text-align:center;padding:20px 14px}
.title{font-size:28px;letter-spacing:.5px}
.inline{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:14px}
.startbtn{margin-top:16px;display:inline-block}
.tag{border:1px solid #2a3553;padding:4px 8px;border-radius:999px}
.review{margin-top:10px}
.review ol{margin:0;padding-left:18px}
</style>
</head>
<body>
<div class="app">
  <!-- START -->
  <div id="start" class="card pad">
    <div class="hero center">
      <div>
        <div class="title" id="dsTitle">ITパスポート問題集</div>
        <div class="sub small" id="info" style="margin-top:10px;">問題データを読み込んでください</div>
        
        <!-- ファイルアップロード -->
        <div class="upload-area" id="uploadArea">
          <p>JSONファイルをドラッグ&ドロップ<br>または<br>
          <input type="file" id="fileInput" accept=".json" style="display:none">
          <button class="btn" onclick="document.getElementById('fileInput').click()">ファイルを選択</button></p>
        </div>
        
        <!-- サンプルデータボタン -->
        <div style="margin:10px 0">
          <button id="loadSample" class="btn ghost">サンプルデータを使用</button>
        </div>
        
        <div class="inline small">
          <label>出題 <select id="count">
            <option value="10">10</option><option value="20">20</option>
            <option value="30">30</option><option value="50">50</option>
            <option value="all" selected>全件</option>
          </select></label>
        </div>
        <div class="startbtn">
          <button id="go" class="btn primary" disabled>開始（模試 120分）</button>
        </div>
      </div>
    </div>
  </div>

  <!-- QUIZ -->
  <div id="quiz" class="hide">
    <!-- HUD -->
    <div class="card pad" style="margin-bottom:12px">
      <div class="top">
        <div class="left">
          <span class="badge">模試</span>
          <strong id="pos">Q - / -</strong>
        </div>
        <div class="counters">
          <span class="counter ok">正解 <span id="ok">0</span></span>
          <span class="counter ng">不正解 <span id="ng">0</span></span>
          <span class="timer" id="timer">120:00</span>
        </div>
      </div>
      <div class="bar"><i id="bar"></i></div>
    </div>

    <!-- 問題 -->
    <div class="card pad" style="margin-bottom:12px">
      <div class="q" id="qText"></div>
      <!-- 選択文はここに出す -->
      <div id="choicesList" class="choice-list"></div>
    </div>

    <!-- ボタン（1行4列／かなのみ） -->
    <div class="answers" id="answers"></div>
  </div>

  <!-- RESULT -->
  <div id="result" class="card pad hide" style="margin-top:12px">
    <div class="top">
      <h2>結果</h2>
      <div class="counters">
        <span class="counter ok">正解 <span id="rok">0</span></span>
        <span class="counter ng">不正解 <span id="rng">0</span></span>
        <span class="badge" id="elapsed">残り --:--</span>
      </div>
    </div>
    <div class="review" id="review"></div>
    <div class="ctrl" style="margin-top:12px">
      <button id="retryWrong" class="btn primary">不正解だけ復習</button>
      <div>
        <button id="retryAll" class="btn">もう一度</button>
        <button id="exportCsv" class="btn ghost">CSV</button>
      </div>
    </div>
  </div>
</div>

<!-- floating nav -->
<button class="fab" id="navFab" title="ナビ"><span>≡</span></button>
<div class="overlay" id="overlay">
  <div class="ov-card">
    <div class="xrow">
      <strong>ナビ（出題順）</strong>
      <button class="close" id="closeOv">閉じる</button>
    </div>
    <div class="grid" id="navGrid"></div>
  </div>
</div>

<script>
/* ===== iOSダブルタップ拡大の抑止 ===== */
let __lastTouchEnd = 0;
document.addEventListener('touchend', (e)=>{
  const now = Date.now();
  if (now - __lastTouchEnd <= 300) { e.preventDefault(); }
  __lastTouchEnd = now;
}, {passive:false});
document.addEventListener('dblclick', e=>e.preventDefault(), {passive:false});
document.addEventListener('gesturestart', e=>e.preventDefault(), {passive:false});

/* ===== 共通 ===== */
const KANA = ['ア','イ','ウ','エ'];
const LIMIT_SEC = 120 * 60;          // 120分
const ADVANCE_DELAY_MS = 240;        // ハイライト表示時間
let RAW=[], POOL=[], ORDER=[];
let CUR=0;
let TIMER_ID=null, remainingSec=LIMIT_SEC;

const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmtTime = sec => { const s=Math.max(0,Math.floor(sec)); return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; };
const shuffle = a => { for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]]; } return a; };

/* ===== サンプルデータ（最初の5問） ===== */
const SAMPLE_DATA = {
  "comment": "ITパスポート試験問題データ - サンプル",
  "generated_at": "2025-01-20T00:00:00.000Z",
  "total_questions": 5,
  "questions": [
    {
      "number": 1,
      "question": "A社がB社に作業の一部を請負契約で委託している。作業形態a〜cのうち、いわゆる偽装請負とみなされる状態だけを全て挙げたものはどれか。\\n\\na　B社の従業員が、A社内において、A社の責任者の指揮命令の下で、請負契約で取り決めた作業を行っている。\\nb　B社の従業員が、A社内において、B社の責任者の指揮命令の下で、請負契約で取り決めた作業を行っている。\\nc　B社の従業員が、B社内において、A社の責任者の指揮命令の下で、請負契約で取り決めた作業を行っている。",
      "choices": [
        "【ア】a",
        "【イ】a, b", 
        "【ウ】a, c",
        "【エ】b, c"
      ],
      "answer_index": 2,
      "comment": "偽装請負：実質的にA社が指揮命令している状態（aとc）が該当"
    },
    {
      "number": 2,
      "question": "従来の情報セキュリティマネジメントシステム規格を基礎に追加で制定されたもので、クラウドサービスに対応した情報セキュリティ管理体制を構築するためのガイドライン規格として、最も適切なものはどれか。",
      "choices": [
        "【ア】ISO 14001",
        "【イ】JIS Q 15001",
        "【ウ】ISO/IEC 27017", 
        "【エ】ISO 9001"
      ],
      "answer_index": 2,
      "comment": "ISO/IEC 27017：クラウドサービス向け情報セキュリティ管理策のガイドライン"
    },
    {
      "number": 3,
      "question": "政府は、官民データ活用推進基本法に定められた\"官民データ活用推進基本計画\"を策定し、官民データの公開や活用の促進に取り組んでいる。次の組織体のうち、官民データを所有しているものだけを全て挙げたものはどれか。\\n\\na　県庁\\nb　大学\\nc　電力事業者\\nd　独立行政法人",
      "choices": [
        "【ア】a, b, c",
        "【イ】a, b, c, d",
        "【ウ】a, b, d", 
        "【エ】a, c, d"
      ],
      "answer_index": 1,
      "comment": "官民データ活用推進基本法：公的機関(a,b,d)と民間事業者(c)すべてが対象"
    },
    {
      "number": 4,
      "question": "投資の優先度などの経営の戦略を策定するために、経済価値、希少性、模倣困難性及び組織の四つの要素で評価することによって、自社のもつ資源を分析する手法として、最も適切なものはどれか。",
      "choices": [
        "【ア】4P",
        "【イ】PPM",
        "【ウ】SWOT分析", 
        "【エ】VRIO分析"
      ],
      "answer_index": 3,
      "comment": "VRIO分析：Value(価値)、Rarity(希少性)、Imitability(模倣困難性)、Organization(組織)で資源分析"
    },
    {
      "number": 5,
      "question": "A社ではB商品の仕入れと販売を行っている。ある期のB商品の仕入単価は期首から上昇し続け、期末が最も高くなった。当該期の売上原価を\"期首棚卸高＋当期商品仕入高－期末棚卸高\"で計算するとき、期末棚卸高の計算に期末の仕入単価を用いると、B商品の期末棚卸高及び売上原価は、期中の仕入単価の平均値を用いる場合に比べてどのようになるか。",
      "choices": [
        "【ア】期末棚卸高、売上原価ともに上がる。",
        "【イ】期末棚卸高、売上原価ともに変わらない。",
        "【ウ】期末棚卸高は上がり、売上原価は下がる。", 
        "【エ】期末棚卸高は下がり、売上原価は上がる。"
      ],
      "answer_index": 2,
      "comment": "期末単価＞平均単価なので、期末棚卸高↑→売上原価は逆算で↓（売上原価=期首棚卸高＋仕入高－期末棚卸高）"
    }
  ]
};

/* ===== プレースホルダ判定＆除去 ===== */
function isPlaceholderChoice(t=''){ return /本文から読込/.test(String(t)); }
function stripPlaceholder(t=''){
  let s = String(t);
  s = s.replace(/^[（(]\s*本文から読込\s*[)）]\s*/,'');
  s = s.replace(/本文から読込/g,'');
  s = s.trim();
  if(/^[アイウエ]$/.test(s)) s = '';
  return s;
}

/* 選択肢頭の「ア/イ/ウ/エ + 記号」を除去 */
function cleanseChoiceHead(t=''){
  return String(t).replace(/^\s*[（(]?[アイウエｲｳｴ]\s*[\)\]）．。･・、:：.\-]?\s*/,'').trim();
}
/* 本文からア/イ/ウ/エを抽出（複数行連結）し本文から除去 */
function splitStemAndChoices(text=''){
  const lines = String(text).split(/\r?\n/);
  const out = [];
  const picked = ['','','',''];
  const map = {'ア':0,'イ':1,'ｲ':1,'ウ':2,'ｳ':2,'エ':3,'ｴ':3};
  const headRe = /^\s*([アイウエｲｳｴ])\s*[\)\]）．。･・、:：.\-]?\s*(.*)$/;
  let cur=-1, started=false;
  for(const raw of lines){
    const ln = raw.trim();
    const m = ln.match(headRe);
    if(m && map[m[1]]!=null){ started=true; cur=map[m[1]]; picked[cur]+=(picked[cur]?' ':'')+m[2].trim(); continue; }
    if(started && cur>=0){ if(ln==='') continue; picked[cur]+=' '+ln; }
    else out.push(raw);
  }
  const extracted = picked.map(s=>s.trim()).map(s=>s? s:null);
  return { stem: out.join('\n').replace(/\n{3,}/g,'\n\n').trim(), extracted };
}
/* 本文の軽い正規化 */
function tidyStem(s=''){ return String(s).replace(/%%/g,'%').replace(/\n{3,}/g,'\n\n').replace(/\\n/g,'\n').trim(); }

/* ===== データロード ===== */
function loadData(data){
  try{
    RAW = (data.questions||[]).map(q=>({...q, selected:null, result:null, seen:false}));
    const full = RAW.filter(q => q.question && q.choices && q.choices.length===4 && Number.isInteger(q.answer_index));
    $('#info').innerHTML = `総数 <strong>${RAW.length}</strong> ／ 出題可能 <strong>${full.length}</strong>`;
    $('#go').disabled = full.length === 0;
    
    if(full.length > 0) {
      $('#dsTitle').textContent = `ITパスポート問題集 (${full.length}問)`;
    }
  }catch(e){
    $('#info').innerHTML = `読み込み失敗：${e.message}`;
    $('#go').disabled = true;
  }
}

/* ===== ファイルアップロード ===== */
const fileInput = $('#fileInput');
const uploadArea = $('#uploadArea');

fileInput.addEventListener('change', handleFile);

uploadArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
  uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadArea.classList.remove('dragover');
  const files = e.dataTransfer.files;
  if (files.length > 0) {
    processFile(files[0]);
  }
});

function handleFile(e) {
  const file = e.target.files[0];
  if (file) {
    processFile(file);
  }
}

function processFile(file) {
  if (!file.name.toLowerCase().endsWith('.json')) {
    alert('JSONファイルを選択してください。');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      loadData(data);
      $('#info').innerHTML += '<br><span style="color: #4caf50;">✓ ファイル読み込み完了</span>';
    } catch (err) {
      alert('JSONファイルの形式が正しくありません。');
    }
  };
  reader.readAsText(file);
}

/* ===== サンプルデータ読み込み ===== */
$('#loadSample').addEventListener('click', () => {
  loadData(SAMPLE_DATA);
  $('#info').innerHTML += '<br><span style="color: #4caf50;">✓ サンプルデータ読み込み完了</span>';
});

/* ===== 開始 ===== */
$('#go').addEventListener('click', () => {
  const cntSel = $('#count').value;
  const full  = RAW.filter(q => q.question && q.choices && q.choices.length===4 && Number.isInteger(q.answer_index));
  POOL = full;
  if(POOL.length===0){ alert('出題できる問題がありません。'); return; }

  ORDER = [...Array(POOL.length).keys()];
  shuffle(ORDER);
  if(cntSel!=='all') ORDER = ORDER.slice(0, Math.min(parseInt(cntSel,10), ORDER.length));

  POOL.forEach(q=>{ q.selected=null; q.result=null; q.seen=false; });
  CUR=0;

  remainingSec = LIMIT_SEC; $('#timer').textContent = fmtTime(remainingSec);
  clearInterval(TIMER_ID);
  TIMER_ID = setInterval(()=>{ remainingSec=Math.max(0,remainingSec-1); $('#timer').textContent=fmtTime(remainingSec); if(remainingSec===0){ clearInterval(TIMER_ID); finish(); } },1000);

  $('#start').classList.add('hide'); $('#quiz').classList.remove('hide');
  render();
});

/* ===== レンダリング ===== */
function render(){
  const idx = ORDER[CUR], q = POOL[idx];
  $('#pos').textContent = `Q ${CUR+1} / ${ORDER.length}`;
  $('#bar').style.width = `${(CUR/Math.max(1,ORDER.length-1))*100}%`;

  // 本文と本文内の抽出
  const { stem, extracted } = splitStemAndChoices(q.question || '');
  $('#qText').textContent = tidyStem(stem || (q.question || ''));

  // 選択肢の優先順位：JSON choices優先 → 全てプレースホルダのときだけ抽出に置換
  let choices = Array.isArray(q.choices) && q.choices.length===4 ? q.choices.slice() : null;
  const extractedFull = extracted.filter(Boolean).length===4;
  const allPlaceholder = choices && choices.every(isPlaceholderChoice);
  if (allPlaceholder && extractedFull) choices = extracted.slice();
  if (!choices && extractedFull) choices = extracted.slice();
  if (choices) choices = choices.map(t => stripPlaceholder(cleanseChoiceHead(t)));

  // 設問カード内に選択文を表示（あれば）
  const list = $('#choicesList'); list.innerHTML='';
  if (choices){
    choices.forEach((t,i)=>{
      const line=document.createElement('div');
      line.className='choice-line';
      const k=document.createElement('span'); k.className='kana'; k.textContent=KANA[i];
      const p=document.createElement('p'); p.textContent = t || '';
      line.appendChild(k); line.appendChild(p);
      list.appendChild(line);
    });
  }

  // 4つの"かな"ボタン
  const answersEl = $('#answers'); answersEl.innerHTML='';
  for(let i=0;i<4;i++){
    const btn=document.createElement('button');
    btn.className='opt'; btn.textContent = KANA[i];

    if (Number.isInteger(q.answer_index) && q.result !== null){
      if (i === q.answer_index) btn.classList.add('correct');
      if (q.selected === i && q.selected !== q.answer_index) btn.classList.add('wrong');
      btn.style.pointerEvents = 'none';
    }

    btn.addEventListener('click',()=>selectChoice(i));
    answersEl.appendChild(btn);
  }

  // 毎問ページ先頭へ
  requestAnimationFrame(()=>{ window.scrollTo(0,0); });

  updateCounters();
  buildNav();
}

/* 回答→採点→ハイライト→自動次へ */
function selectChoice(i){
  const idx = ORDER[CUR], q = POOL[idx];
  q.selected = i;
  q.result = (i === q.answer_index);
  render();
  setTimeout(advance, ADVANCE_DELAY_MS);
}
function advance(){ (CUR<ORDER.length-1) ? (CUR++,render()) : finish(); }

/* ナビ */
$('#navFab').addEventListener('click', ()=> $('#overlay').style.display='flex');
$('#closeOv').addEventListener('click', ()=> $('#overlay').style.display='none');
function buildNav(){
  const g = $('#navGrid'); g.innerHTML='';
  ORDER.forEach((i,idx)=>{
    const q=POOL[i];
    const b=document.createElement('button');
    b.className='navbtn'; b.textContent = (idx+1);
    if(q.result===true) b.classList.add('ok');
    else if(q.result===false) b.classList.add('ng');
    else if(q.selected!=null) b.style.borderColor='#3a4a6b';
    if(idx===CUR) b.classList.add('cur');
    b.addEventListener('click',()=>{ CUR=idx; $('#overlay').style.display='none'; render(); });
    g.appendChild(b);
  });
}

/* 採点＆結果 */
function finish(){
  clearInterval(TIMER_ID);
  for(const q of POOL){
    if(Number.isInteger(q.answer_index) && q.selected!=null){
      q.result = (q.selected===q.answer_index);
    }
  }
  $('#quiz').classList.add('hide'); $('#result').classList.remove('hide');

  const ok = POOL.filter(x=>x.result===true).length;
  const ng = POOL.filter(x=>x.result===false).length;
  $('#rok').textContent = ok; $('#rng').textContent = ng;
  $('#elapsed').textContent = `残り ${fmtTime(remainingSec)}`;

  const wrongs = POOL.filter(x=>x.result===false).map(x=>({num:x.number ?? '-', q:x.question || '（本文なし）', ans:x.answer_index, sel:x.selected}));
  const box = $('#review'); box.innerHTML='';
  if(wrongs.length===0){ box.innerHTML='<p class="small">全問正解！</p>'; }
  else{
    const ol=document.createElement('ol');
    wrongs.forEach(w=>{
      const li=document.createElement('li');
      const ck = Number.isInteger(w.ans) ? KANA[w.ans] : '-';
      const sk = Number.isInteger(w.sel) ? KANA[w.sel] : '-';
      li.innerHTML = `<small class="muted">正解:${ck}／あなた:${sk}</small><br>${escapeHtml(w.q)}`;
      ol.appendChild(li);
    });
    box.appendChild(ol);
  }
}

/* 結果画面操作 */
$('#retryWrong').addEventListener('click', ()=>{
  const wrongIdx = ORDER.filter(i => { const q=POOL[i]; return q.result===false && Number.isInteger(q.answer_index); });
  if(wrongIdx.length===0){ alert('不正解がありません。'); return; }
  ORDER = wrongIdx;
  ORDER.forEach(i=>{ POOL[i].selected=null; POOL[i].result=null; });
  CUR=0; remainingSec = LIMIT_SEC;
  clearInterval(TIMER_ID);
  TIMER_ID = setInterval(()=>{ remainingSec=Math.max(0,remainingSec-1); $('#timer').textContent=fmtTime(remainingSec); if(remainingSec===0){ clearInterval(TIMER_ID); finish(); } },1000);
  $('#result').classList.add('hide'); $('#quiz').classList.remove('hide');
  render();
});
$('#retryAll').addEventListener('click', ()=>{ $('#result').classList.add('hide'); $('#start').classList.remove('hide'); });

/* CSV */
$('#exportCsv').addEventListener('click', ()=>{
  const rows = [['dataset','index','number','selectedKana','correctKana','result']];
  ORDER.forEach((i,idx)=>{
    const q=POOL[i];
    const sel = q.selected!=null ? KANA[q.selected] : '';
    const cor = Number.isInteger(q.answer_index) ? KANA[q.answer_index] : '';
    const res = q.result==null ? '' : (q.result?'OK':'NG');
    rows.push(['ITパスポート', idx+1, q.number ?? '', sel, cor, res]);
  });
  const csv = rows.map(r=>r.map(s=>`"${String(s??'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`itpassport_result.csv`; a.click(); URL.revokeObjectURL(a.href);
});

/* 小物 */
function updateCounters(){ $('#ok').textContent = POOL.filter(x=>x.result===true).length; $('#ng').textContent = POOL.filter(x=>x.result===false).length; }
function escapeHtml(s){ return String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

// 初期化
$('#go').disabled = true;
