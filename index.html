<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Trainer Minimal</title>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
<style>
:root{ --bg:#0b0d14; --panel:#121623; --accent:#52b2ff; --text:#eef3ff; --muted:#91a0bd; --ok:#4caf50; --ng:#ef5350; --line:#20273a; }
*{box-sizing:border-box}
html,body{height:100%}
body{ margin:0;background:linear-gradient(180deg,#0b0d14,#0a1020); color:var(--text);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; overscroll-behavior:none; touch-action:manipulation; overflow-x:hidden;}
.app{max-width:960px;margin:0 auto;padding:18px 18px calc(18px + env(safe-area-inset-bottom));min-height:100svh;display:block;}
.card{background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,.28)}
.pad{padding:18px}
h1,h2,p{margin:0}
.muted{color:var(--muted)} .small{font-size:12px} .hide{display:none}

/* header */
.top{display:flex;align-items:center;gap:12px;justify-content:space-between}
.top .left{display:flex;align-items:center;gap:10px}
.badge{font-size:12px;padding:2px 8px;border:1px solid var(--line);border-radius:999px;color:#bcd2ff}
.timer{font-variant-numeric:tabular-nums}
.counters{display:flex;gap:10px}
.counter{font-variant-numeric:tabular-nums}
.counter.ok{color:#b7ffb7}
.counter.ng{color:#ffb4b4}

/* progress */
.bar{height:10px;background:#1a2132;border-radius:999px;overflow:hidden;margin:10px 0 14px}
.bar>i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#95d0ff);width:0%}

/* q & answers */
.q{font-size:18px;white-space:pre-wrap}
.answers{display:grid;gap:10px;margin-top:12px}
@media(min-width:720px){.answers{grid-template-columns:1fr 1fr}}
.opt{padding:14px;border:1px solid #27314a;background:#151c2c;border-radius:12px;cursor:pointer;text-align:left}
.opt:hover{border-color:#33415f}
.opt, .opt *{color:var(--text)!important}
.opt.correct{border-color:var(--ok);background:rgba(76,175,80,.10)}
.opt.wrong{border-color:var(--ng);background:rgba(239,83,80,.10)}
.opt.disabled{opacity:.65;pointer-events:none}
.kana{display:inline-block;min-width:2ch;text-align:center;margin-right:.6rem;color:#b9c6e6}

/* controls */
.ctrl{display:flex;gap:8px;justify-content:space-between;margin-top:12px}
.btn{display:inline-flex;align-items:center;gap:.5rem;padding:10px 14px;border:1px solid #2a3349;border-radius:12px;background:#151c2b;color:var(--text);cursor:pointer}
.btn:hover{border-color:#384766}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.primary{background:linear-gradient(180deg,#1b2b48,#15243d);border-color:#2e3d5c}
.ghost{background:transparent}

/* floating nav */
.fab{position:fixed;right:16px;bottom:calc(16px + env(safe-area-inset-bottom));width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#16213a;border:1px solid #283655;cursor:pointer;box-shadow:0 10px 24px rgba(0,0,0,.35);z-index:50}
.fab span{font-size:20px;line-height:1}

/* overlay nav */
.overlay{position:fixed;inset:0;background:rgba(6,10,20,.65);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;padding:16px;z-index:40}
.ov-card{width:min(860px,92vw);max-height:80vh;overflow:auto;background:#0f1426;border:1px solid #2b3653;border-radius:14px;padding:14px}
.grid{display:grid;grid-template-columns:repeat(10,1fr);gap:6px}
.navbtn{padding:8px;border:1px solid #2a3553;background:#121a33;color:#cdd7f3;border-radius:10px;cursor:pointer}
.navbtn:hover{border-color:#3c4c75}
.navbtn.cur{outline:2px solid var(--accent)}
.navbtn.ok{border-color:#2e7d32;background:rgba(46,125,50,.15)}
.navbtn.ng{border-color:#b23a3a;background:rgba(178,58,58,.12)}
.xrow{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.close{padding:6px 10px;border:1px solid #2a3553;border-radius:999px;background:#121a33;color:#cdd7f3;cursor:pointer}

/* START (exam only) */
.center{display:grid;place-items:center;min-height:70vh}
.hero{text-align:center;padding:20px 14px}
.title{font-size:28px;letter-spacing:.5px}
.sub{margin-top:6px;color:#b4c1df}
.inline{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:14px}
.startbtn{margin-top:16px;display:inline-block}
.tag{border:1px solid #2a3553;padding:4px 8px;border-radius:999px}
.review{margin-top:10px}
.review ol{margin:0;padding-left:18px}
</style>
</head>
<body>
<div class="app">
  <!-- START (模試のみ) -->
  <div id="start" class="card pad">
    <div class="hero center">
      <div>
        <div class="title">Trainer <span class="tag">Minimal</span></div>
        <div class="sub small" id="info">データ読込中…</div>

        <div class="inline small">
          <label>出題 <select id="count">
            <option value="10">10</option><option value="20">20</option>
            <option value="30">30</option><option value="50">50</option>
            <option value="all" selected>全件</option>
          </select></label>
          <label><input type="checkbox" id="stubs" checked> スタブ含む</label>
        </div>

        <div class="startbtn">
          <button id="go" class="btn primary">開始（模試 120分）</button>
          <button id="reload" class="btn ghost">再読込</button>
        </div>
      </div>
    </div>
  </div>

  <!-- QUIZ -->
  <div id="quiz" class="card pad hide">
    <div class="top">
      <div class="left">
        <span class="badge">EXAM</span>
        <strong id="pos">Q - / -</strong>
      </div>
      <div class="counters">
        <span class="counter ok">OK <span id="ok">0</span></span>
        <span class="counter ng">NG <span id="ng">0</span></span>
        <span class="badge timer" id="timer">120:00</span>
      </div>
    </div>
    <div class="bar"><i id="bar"></i></div>
    <div class="q" id="qText"></div>
    <div class="answers" id="answers"></div>
    <div class="ctrl">
      <button id="prev" class="btn">← 戻る</button>
      <div>
        <button id="skip" class="btn">スキップ</button>
        <button id="next" class="btn primary">次へ →</button>
      </div>
    </div>
  </div>

  <!-- RESULT -->
  <div id="result" class="card pad hide">
    <div class="top">
      <h2>結果</h2>
      <div class="counters">
        <span class="counter ok">OK <span id="rok">0</span></span>
        <span class="counter ng">NG <span id="rng">0</span></span>
        <span class="badge" id="elapsed">残り --:--</span>
      </div>
    </div>
    <div class="review" id="review"></div>
    <div class="ctrl" style="margin-top:12px">
      <button id="retryWrong" class="btn primary">不正解だけ復習</button>
      <div>
        <button id="retryAll" class="btn">もう一度</button>
        <button id="exportCsv" class="btn ghost">CSV</button>
      </div>
    </div>
  </div>
</div>

<!-- floating nav -->
<button class="fab" id="navFab" title="ナビ"><span>≡</span></button>
<div class="overlay" id="overlay">
  <div class="ov-card">
    <div class="xrow">
      <strong>ナビ（出題順）</strong>
      <button class="close" id="closeOv">閉じる</button>
    </div>
    <div class="grid" id="navGrid"></div>
  </div>
</div>

<script>
const DATA_URL = './data/itpassport_2025r07.json';
const KANA = ['ア','イ','ウ','エ'];
const LIMIT_SEC = 120 * 60;      // 120分カウントダウン（模試のみ）
const ADVANCE_DELAY_MS = 200;     // 学習排除後も演出用に残す（今は未使用でも可）

let RAW=[], POOL=[], ORDER=[];
let CUR=0, INCLUDE_STUBS=true;
let TIMER_ID=null, remainingSec=LIMIT_SEC;

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmtTime = sec => { const s=Math.max(0,Math.floor(sec)); return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; };
const shuffle = a => { for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };

/** 問題文に混在する「ア/イ/ウ/エ …」行を除去し、抽出もする */
function splitStemAndChoices(text=''){
  const lines = String(text).split(/\r?\n/);
  const outLines = [];
  const extracted = [null,null,null,null];
  const idxMap = { 'ア':0,'ｲ':1,'イ':1,'ｳ':2,'ウ':2,'ｴ':3,'エ':3 };
  const re = /^\s*([アイウエｲｳｴ])[\s\)\]．。･・、:：.\-]*\s*(.*)$/;
  for(const ln of lines){
    const m = ln.match(re);
    if(m && idxMap[m[1]]!=null){
      const i = idxMap[m[1]];
      extracted[i] = (extracted[i] ? (extracted[i]+' '+m[2]) : m[2]).trim();
    }else{
      outLines.push(ln);
    }
  }
  return { stem: outLines.join('\n').replace(/\n{3,}/g,'\n\n').trim(), extracted };
}

async function loadData(){
  $('#info').textContent = 'データ読込中…';
  try{
    const r = await fetch(DATA_URL,{cache:'no-store'});
    if(!r.ok) throw new Error(r.status+' '+r.statusText);
    const data = await r.json();
    RAW = (data.questions||[]).map(q=>({...q, selected:null, result:null, seen:false}));
    const full = RAW.filter(q => q.question && q.choices && q.choices.length===4 && Number.isInteger(q.answer_index));
    const stub = RAW.filter(q => !(q.question && q.choices && q.choices.length===4));
    $('#info').innerHTML = `総数 <strong>${RAW.length}</strong> ／ 完全 <strong>${full.length}</strong> ／ スタブ <strong>${stub.length}</strong>`;
  }catch(e){
    $('#info').innerHTML = `読み込み失敗：${e.message}`;
  }
}
loadData();
$('#reload').addEventListener('click', loadData);

$('#go').addEventListener('click', () => {
  INCLUDE_STUBS = $('#stubs').checked;
  const cntSel = $('#count').value;

  const full = RAW.filter(q => q.question && q.choices && q.choices.length===4 && Number.isInteger(q.answer_index));
  const stubs = RAW.filter(q => !(q.question && q.choices && q.choices.length===4));
  POOL = INCLUDE_STUBS ? [...full, ...stubs] : full;
  if(POOL.length===0){ alert('出題できる問題がありません。'); return; }

  ORDER = [...Array(POOL.length).keys()];
  shuffle(ORDER);
  if(cntSel!=='all') ORDER = ORDER.slice(0, Math.min(parseInt(cntSel,10), ORDER.length));

  POOL.forEach(q=>{ q.selected=null; q.result=null; q.seen=false; });
  CUR=0;

  remainingSec = LIMIT_SEC;
  $('#timer').textContent = fmtTime(remainingSec);
  startTimer();

  $('#start').classList.add('hide');
  $('#quiz').classList.remove('hide');

  render();
});

function startTimer(){
  clearInterval(TIMER_ID);
  TIMER_ID = setInterval(()=>{
    remainingSec = Math.max(0, remainingSec - 1);
    $('#timer').textContent = fmtTime(remainingSec);
    if(remainingSec === 0){ clearInterval(TIMER_ID); finish(); }
  }, 1000);
}

function render(){
  const idx = ORDER[CUR], q = POOL[idx];
  $('#pos').textContent = `Q ${CUR+1} / ${ORDER.length}`;
  $('#bar').style.width = `${(CUR/Math.max(1,ORDER.length-1))*100}%`;

  const { stem, extracted } = splitStemAndChoices(q.question || '');
  $('#qText').textContent = stem || (q.question || '');

  let choices = (q.choices && q.choices.length===4) ? q.choices : null;
  if(!choices && extracted.filter(Boolean).length===4) choices = extracted;

  const answersEl = $('#answers'); answersEl.innerHTML='';
  if(choices){
    choices.forEach((text,i)=>{
      const btn=document.createElement('button');
      btn.className='opt';
      btn.innerHTML = `<span class="kana">${KANA[i]}</span>${escapeHtml(text)}`;
      if(q.selected===null){} // no class
      if(q.result!==null){
        if(i===q.answer_index) btn.classList.add('correct');
        if(q.selected===i && !q.result) btn.classList.add('wrong');
      }
      btn.addEventListener('click',()=>selectChoice(i));
      answersEl.appendChild(btn);
    });
  }else{
    const stub=document.createElement('div');
    stub.className='muted small';
    stub.textContent='選択肢未収録：この設問は採点対象外';
    answersEl.appendChild(stub);
  }

  $('#prev').disabled = CUR===0;
  $('#next').disabled = CUR>=ORDER.length-1;

  updateCounters();
  buildNav();
}

function selectChoice(i){
  const idx = ORDER[CUR], q = POOL[idx];
  q.selected = i;            // 模試：選択だけ記録
  advance();                 // 即次へ
}

function advance(){ (CUR<ORDER.length-1) ? (CUR++,render()) : finish(); }

$('#prev').addEventListener('click', ()=>{ if(CUR>0){ CUR--; render(); }});
$('#next').addEventListener('click', ()=> advance());
$('#skip').addEventListener('click', ()=> advance());

$('#navFab').addEventListener('click', ()=> $('#overlay').style.display='flex');
$('#closeOv').addEventListener('click', ()=> $('#overlay').style.display='none');

function buildNav(){
  const g = $('#navGrid'); g.innerHTML='';
  ORDER.forEach((i,idx)=>{
    const q=POOL[i];
    const b=document.createElement('button');
    b.className='navbtn';
    b.textContent = (idx+1); // 出題順
    if(q.result===true) b.classList.add('ok');
    else if(q.result===false) b.classList.add('ng');
    else if(q.selected!=null) b.style.borderColor='#3a4a6b';
    if(idx===CUR) b.classList.add('cur');
    b.addEventListener('click',()=>{ CUR=idx; $('#overlay').style.display='none'; render(); });
    g.appendChild(b);
  });
}

function finish(){
  clearInterval(TIMER_ID);
  // 採点
  for(const q of POOL){
    if(Number.isInteger(q.answer_index) && q.selected!=null){
      q.result = (q.selected===q.answer_index);
    }
  }
  $('#quiz').classList.add('hide');
  $('#result').classList.remove('hide');

  const ok = POOL.filter(x=>x.result===true).length;
  const ng = POOL.filter(x=>x.result===false).length;
  $('#rok').textContent = ok;
  $('#rng').textContent = ng;
  $('#elapsed').textContent = `残り ${fmtTime(remainingSec)}`;

  const wrongs = POOL.filter(x=>x.result===false).map(x=>({num:x.number ?? '-', q:x.question || '（本文なし）', ans:x.answer_index, sel:x.selected}));
  const box = $('#review'); box.innerHTML='';
  if(wrongs.length===0){ box.innerHTML='<p class="small">全問正解！</p>'; }
  else{
    const ol=document.createElement('ol');
    wrongs.forEach(w=>{
      const li=document.createElement('li');
      const ck = Number.isInteger(w.ans) ? KANA[w.ans] : '-';
      const sk = Number.isInteger(w.sel) ? KANA[w.sel] : '-';
      li.innerHTML = `<small class="muted">正解:${ck}／あなた:${sk}</small><br>${escapeHtml(w.q)}`;
      ol.appendChild(li);
    });
    box.appendChild(ol);
  }
}

$('#retryWrong').addEventListener('click', ()=>{
  const wrongIdx = ORDER.filter(i => {
    const q=POOL[i]; return q.result===false && Number.isInteger(q.answer_index);
  });
  if(wrongIdx.length===0){ alert('不正解がありません。'); return; }
  ORDER = wrongIdx;
  ORDER.forEach(i=>{ POOL[i].selected=null; POOL[i].result=null; });
  CUR=0; remainingSec = LIMIT_SEC; startTimer();
  $('#result').classList.add('hide'); $('#quiz').classList.remove('hide');
  render();
});

$('#retryAll').addEventListener('click', ()=>{
  $('#result').classList.add('hide'); $('#start').classList.remove('hide');
});

$('#exportCsv').addEventListener('click', ()=>{
  const rows = [['index','number','selectedKana','correctKana','result']];
  ORDER.forEach((i,idx)=>{
    const q=POOL[i];
    const sel = q.selected!=null ? KANA[q.selected] : '';
    const cor = Number.isInteger(q.answer_index) ? KANA[q.answer_index] : '';
    const res = q.result==null ? '' : (q.result?'OK':'NG');
    rows.push([idx+1, q.number ?? '', sel, cor, res]);
  });
  const csv = rows.map(r=>r.map(s=>`"${String(s??'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='itpassport_result.csv'; a.click(); URL.revokeObjectURL(a.href);
});

function updateCounters(){
  const ok = POOL.filter(x=>x.result===true).length;
  const ng = POOL.filter(x=>x.result===false).length;
  $('#ok').textContent = ok;
  $('#ng').textContent = ng;
}

function escapeHtml(s){ return String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
</script>
</body>
</html>